<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Habits</title>
  
  <!-- Supabase Library -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* --- STYLES (Unchanged) --- */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --bg-color: #000000; --card-bg: #1C1C1E; --text-primary: #FFFFFF;
      --text-secondary: #8E8E93; --accent-color: #0A84FF; --success-color: #30D158;
      --danger-color: #FF453A; --separator: #38383A;
      --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    }
    body { background-color: var(--bg-color); color: var(--text-primary); font-family: var(--font-family); padding-bottom: 90px; overflow-x: hidden; }
    .view-section { display: none; padding-bottom: 20px; }
    .view-section.active { display: block; animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .top-bar { display: flex; justify-content: space-between; align-items: flex-end; padding: 16px 20px 10px; position: sticky; top: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); z-index: 100; }
    .app-title { font-size: 34px; font-weight: 700; letter-spacing: -0.5px; }
    .top-actions { display: flex; align-items: center; gap: 16px; }
    .date-selector { color: var(--text-primary); font-size: 17px; font-weight: 600; display: flex; align-items: center; gap: 6px; cursor: pointer; background: rgba(255,255,255,0.1); padding: 6px 14px; border-radius: 20px; }
    .date-dropdown { position: absolute; top: 45px; right: 0; background: #2C2C2E; border-radius: 14px; width: 220px; padding: 8px; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 200; border: 1px solid #38383A; }
    .date-dropdown.active { display: block; }
    .date-option { padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; justify-content: space-between; }
    .date-option:hover { background: #3A3A3C; }
    .date-option.selected { color: var(--accent-color); font-weight: 600; }
    .icon-btn { font-size: 22px; color: var(--accent-color); cursor: pointer; padding: 4px; }
    .habit-list { padding: 10px 16px; display: flex; flex-direction: column; gap: 12px; }
    .habit-card { background-color: var(--card-bg); border-radius: 14px; padding: 16px; display: flex; align-items: center; justify-content: space-between; position: relative; }
    .habit-left { display: flex; align-items: center; gap: 14px; flex: 1; cursor: pointer; }
    .habit-icon { font-size: 24px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 12px; }
    .habit-details { display: flex; flex-direction: column; gap: 4px; }
    .habit-name { font-size: 17px; font-weight: 600; }
    .habit-meta { font-size: 13px; color: var(--text-secondary); }
    .check-circle { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #48484A; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .check-circle.completed { background-color: var(--success-color); border-color: var(--success-color); box-shadow: 0 0 15px rgba(48, 209, 88, 0.2); }
    .check-circle.completed::after { content: '‚úì'; font-size: 18px; color: black; font-weight: 800; }
    .stats-container { padding: 16px; }
    .stats-card-large { background-color: var(--card-bg); border-radius: 18px; padding: 24px 20px; margin-bottom: 16px; text-align: center; }
    .gauge-wrapper { position: relative; width: 180px; height: 90px; margin: 0 auto 10px; overflow: hidden; }
    .gauge-arc-bg { position: absolute; top: 0; left: 0; width: 180px; height: 180px; border-radius: 50%; border: 16px solid #2C2C2E; box-sizing: border-box; }
    .gauge-arc-fill { position: absolute; top: 0; left: 0; width: 180px; height: 180px; border-radius: 50%; border: 16px solid transparent; border-top-color: var(--accent-color); border-right-color: var(--accent-color); box-sizing: border-box; transform: rotate(-45deg); transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .gauge-label-main { font-size: 42px; font-weight: 800; color: white; margin-top: -10px; }
    .gauge-label-sub { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .stat-box { background-color: var(--card-bg); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; justify-content: space-between; height: 110px; }
    .stat-label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--success-color); }
    .heat-map-container { overflow-x: auto; padding-bottom: 10px; }
    .heat-map { display: grid; grid-template-rows: repeat(7, 1fr); grid-auto-flow: column; gap: 4px; height: 140px; }
    .heat-dot { width: 14px; height: 14px; background-color: #2C2C2E; border-radius: 4px; }
    .heat-dot.active { background-color: var(--accent-color); }
    .goal-card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 12px; }
    .goal-header { display: flex; justify-content: space-between; margin-bottom: 16px; align-items: flex-start; }
    .goal-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .goal-date { font-size: 13px; color: var(--text-secondary); }
    .progress-track { background: #2C2C2E; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 12px; }
    .progress-bar { height: 100%; background: var(--accent-color); border-radius: 5px; transition: width 0.3s ease; }
    .bottom-nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background-color: rgba(28, 28, 30, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 35px; padding: 6px 8px; display: flex; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 1000; border: 0.5px solid rgba(255,255,255,0.15); }
    .nav-item { width: 50px; height: 50px; border-radius: 25px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #8E8E93; cursor: pointer; transition: all 0.2s ease; }
    .nav-item.active { background-color: #3A3A3C; color: white; }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: black; z-index: 2000; display: none; flex-direction: column; animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
    .modal.active { display: flex; }
    .modal-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; background: #1C1C1E; border-bottom: 0.5px solid #2C2C2E; }
    .modal-content { padding: 20px; flex: 1; overflow-y: auto; }
    .modal-action { color: var(--accent-color); font-size: 17px; cursor: pointer; }
    .modal-action.danger { color: var(--danger-color); }
    .form-group { background: #2C2C2E; border-radius: 12px; padding: 0 16px; margin-bottom: 24px; }
    .form-row { display: flex; align-items: center; padding: 16px 0; border-bottom: 0.5px solid #38383A; }
    .form-row:last-child { border-bottom: none; }
    .form-input { background: transparent; border: none; color: white; font-size: 17px; flex: 1; margin-left: 12px; outline: none; }
    select:focus, input:focus { outline: none; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .habit-detail-view { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: black; z-index: 1500; display: none; flex-direction: column; animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .habit-detail-view.active { display: flex; }
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
    
    /* Connection Status Toast */
    #connection-status {
      position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
      background: #FF9F0A; color: black; padding: 6px 12px; border-radius: 20px;
      font-size: 12px; font-weight: 700; z-index: 3000; display: none;
    }
  </style>
</head>
<body>

  <!-- STATUS TOAST -->
  <div id="connection-status">Offline Mode</div>

  <!-- VIEW: HABITS -->
  <div id="view-habits" class="view-section active">
    <div class="top-bar">
      <div class="app-title">Habits</div>
      <div class="top-actions">
        <div class="date-selector-container">
          <div class="date-selector" onclick="toggleDateDropdown()">
            <span id="current-date-display">Today</span> <span style="font-size:12px; opacity:0.7;">‚ñº</span>
          </div>
          <div class="date-dropdown" id="date-dropdown">
            <div class="date-option" onclick="changeDate(-1)">Yesterday</div>
            <div class="date-option selected" onclick="changeDate(0)">Today</div>
            <div class="date-option" onclick="changeDate(1)">Tomorrow</div>
          </div>
        </div>
        <div class="icon-btn" onclick="openAddModal()">‚ûï</div>
      </div>
    </div>
    <div class="habit-list" id="habits-container">
      <div style="text-align:center; margin-top:40px; color:#8E8E93;">Starting app...</div>
    </div>
  </div>

  <!-- VIEW: STATS -->
  <div id="view-stats" class="view-section stats-container">
    <div class="app-title" style="margin-bottom: 20px;">Statistics</div>
    <div class="stats-card-large">
      <div class="gauge-wrapper"><div class="gauge-arc-bg"></div><div class="gauge-arc-fill" id="gauge-fill"></div></div>
      <div class="gauge-label-main" id="stats-percentage">0%</div>
      <div class="gauge-label-sub">Daily Completion</div>
    </div>
    <div class="grid-2">
      <div class="stat-box"><div class="stat-label">Accuracy</div><div class="stat-value" id="stats-accuracy">0%</div></div>
      <div class="stat-box"><div class="stat-label">Consistency</div><div class="stat-value" style="color:var(--accent-color);" id="stats-consistency">0%</div></div>
    </div>
    <div class="stats-card-large" style="text-align: left;">
      <div class="heat-map-container"><div class="heat-map" id="heat-map"></div></div>
    </div>
  </div>

  <!-- VIEW: GOALS -->
  <div id="view-goals" class="view-section" style="padding: 20px;">
    <div class="top-bar"><div class="app-title">Goals</div><div class="icon-btn" onclick="openGoalModal()">‚ûï</div></div>
    <div id="goals-container"></div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchView('habits', this)">üìÖ</div>
    <div class="nav-item" onclick="switchView('stats', this)">üìä</div>
    <div class="nav-item" onclick="switchView('goals', this)">üéØ</div>
  </div>

  <!-- MODALS -->
  <div id="modal-habit" class="modal">
    <div class="modal-header">
      <div class="modal-action" onclick="closeModal('habit')">Cancel</div>
      <div class="modal-title" id="habit-modal-title">New Habit</div>
      <div class="modal-action" style="font-weight:600;" onclick="saveHabit()">Save</div>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <div class="form-row"><span>üìù</span><input type="text" id="habit-name" class="form-input" placeholder="Name" /></div>
        <div class="form-row"><span>üìÑ</span><input type="text" id="habit-desc" class="form-input" placeholder="Description" /></div>
      </div>
      <div class="form-group">
        <div class="form-row"><span>Icon</span><input type="text" id="habit-icon" class="form-input" value="üìö" style="text-align:right; width:50px;" /></div>
        <div class="form-row"><span>Color</span><select id="habit-color" style="background:none; border:none; color:white; text-align:right;"><option value="#0A84FF">Blue</option><option value="#FF453A">Red</option></select></div>
      </div>
      <div class="form-group" id="delete-section" style="display:none; margin-top:30px;"><div class="form-row" style="justify-content: center;"><span class="modal-action danger" onclick="deleteHabit()">Delete Habit</span></div></div>
    </div>
  </div>

  <div id="modal-goal" class="modal">
    <div class="modal-header"><div class="modal-action" onclick="closeModal('goal')">Cancel</div><div class="modal-title">New Goal</div><div class="modal-action" onclick="saveGoal()">Save</div></div>
    <div class="modal-content">
      <div class="form-group">
        <div class="form-row"><span>üéØ</span><input type="text" id="goal-title" class="form-input" placeholder="Goal Title" /></div>
        <div class="form-row"><span>üìÖ</span><input type="date" id="goal-date" class="form-input" style="color-scheme: dark;" /></div>
      </div>
    </div>
  </div>

  <div id="view-habit-detail" class="habit-detail-view">
    <div class="modal-header"><div class="modal-action" onclick="closeHabitDetail()">‚Üê Back</div><div class="modal-title">Details</div><div class="modal-action" onclick="editCurrentHabit()">Edit</div></div>
    <div class="modal-content">
      <div class="stats-card-large" style="padding: 30px;">
        <div style="font-size: 50px; margin-bottom: 16px;" id="detail-icon"></div>
        <div style="font-size: 28px; font-weight: 700;" id="detail-name"></div>
        <div style="color: var(--text-secondary); margin-top: 6px; font-size: 16px;" id="detail-desc"></div>
      </div>
      <div class="grid-2">
        <div class="stat-box"><div class="stat-label">Current Streak</div><div class="stat-value" id="detail-streak">0</div></div>
        <div class="stat-box"><div class="stat-label">Total</div><div class="stat-value" id="detail-total">0</div></div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://dssywydywiqukaagisce.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzc3l3eWR5d2lxdWthYWdpc2NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3ODQzMjksImV4cCI6MjA4NjM2MDMyOX0.nGzvYHRWGKWPWc8wsjt19Xfx9btCZkyrz-YueksnLkI';

    let supabase = null;
    let useOffline = false;
    let habits = [];
    let completions = [];
    let goals = [];
    let selectedDate = new Date();
    let currentHabitId = null;

    async function initApp() {
      // 1. Try to init Supabase with a timeout
      try {
        if (typeof supabasejs === 'undefined' && typeof window.supabase === 'undefined') {
          throw new Error("Supabase script failed to load");
        }
        
        // Use global variable
        const createClient = window.supabase ? window.supabase.createClient : supabasejs.createClient;
        supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Race condition: If Supabase takes > 2s, switch to offline
        const timeout = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 2000));
        
        // Try simple fetch to test connection
        await Promise.race([
          supabase.from('habits').select('count').limit(1),
          timeout
        ]);

        console.log("Connected to Supabase");
        await loadCloudData();

      } catch (err) {
        console.warn("Switching to Offline Mode:", err);
        enableOfflineMode();
      }
      
      updateDateDisplay();
    }

    function enableOfflineMode() {
      useOffline = true;
      document.getElementById('connection-status').style.display = 'block';
      
      // Load from LocalStorage
      const savedHabits = localStorage.getItem('habits');
      const savedComps = localStorage.getItem('completions');
      const savedGoals = localStorage.getItem('goals');
      
      if (savedHabits) habits = JSON.parse(savedHabits);
      else {
        // Default data for first run offline
        habits = [{id: 1, name: "Read", description: "Offline mode", icon: "üìö", icon_color: "#FF453A"}];
      }
      if (savedComps) completions = JSON.parse(savedComps);
      if (savedGoals) goals = JSON.parse(savedGoals);

      renderHabits();
      renderStats();
      renderGoals();
    }

    async function loadCloudData() {
      // Auto-Login Anon
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        await supabase.auth.signUp({ email: `user${Date.now()}@anon.com`, password: 'password123' });
      }

      const [h, c, g] = await Promise.all([
        supabase.from('habits').select('*'),
        supabase.from('completions').select('*'),
        supabase.from('goals').select('*')
      ]);

      if (h.data) habits = h.data;
      if (c.data) completions = c.data;
      if (g.data) goals = g.data;

      renderHabits();
      renderStats();
      renderGoals();
    }

    // --- RENDERING ---
    function renderHabits() {
      const container = document.getElementById('habits-container');
      container.innerHTML = '';
      const dateKey = selectedDate.toISOString().split('T')[0];

      if (habits.length === 0) {
        container.innerHTML = '<div style="text-align:center;margin-top:40px;color:#8E8E93">No habits found</div>';
        return;
      }

      habits.forEach(habit => {
        const isCompleted = completions.some(c => c.habit_id == habit.id && c.completed_at.startsWith(dateKey));
        const div = document.createElement('div');
        div.className = 'habit-card';
        div.innerHTML = `
          <div class="habit-left" onclick="openHabitDetail(${habit.id})">
            <div class="habit-icon">${habit.icon || '‚ú®'}</div>
            <div class="habit-details"><div class="habit-name">${habit.name}</div><div class="habit-meta">${habit.description || ''}</div></div>
          </div>
          <div class="check-circle ${isCompleted ? 'completed' : ''}" onclick="toggleHabit(${habit.id}, ${isCompleted})" style="${isCompleted ? 'background:#0A84FF;border-color:#0A84FF' : ''}"></div>
        `;
        container.appendChild(div);
      });
    }

    async function toggleHabit(id, isCompleted) {
      const dateKey = selectedDate.toISOString().split('T')[0];
      
      if (isCompleted) {
        // Remove
        const rec = completions.find(c => c.habit_id == id && c.completed_at.startsWith(dateKey));
        if (rec) {
          completions = completions.filter(c => c != rec);
          if (useOffline) localStorage.setItem('completions', JSON.stringify(completions));
          else await supabase.from('completions').delete().eq('id', rec.id);
        }
      } else {
        // Add
        const newC = { habit_id: id, completed_at: new Date(selectedDate).toISOString(), id: Date.now() }; // Temp ID
        completions.push(newC);
        if (useOffline) localStorage.setItem('completions', JSON.stringify(completions));
        else {
           delete newC.id; // Let DB assign ID
           const { data } = await supabase.from('completions').insert(newC).select();
           if(data) {
             completions.pop(); // Remove temp
             completions.push(data[0]); // Add real
           }
        }
      }
      renderHabits();
      renderStats();
    }

    async function saveHabit() {
      const name = document.getElementById('habit-name').value;
      const desc = document.getElementById('habit-desc').value;
      const icon = document.getElementById('habit-icon').value;
      if (!name) return;

      const newHabit = { name, description: desc, icon };
      
      if (useOffline) {
        newHabit.id = Date.now();
        habits.push(newHabit);
        localStorage.setItem('habits', JSON.stringify(habits));
      } else {
        const { data } = await supabase.from('habits').insert(newHabit).select();
        if (data) habits.push(data[0]);
      }
      closeModal('habit');
      renderHabits();
    }

    // --- INIT ---
    initApp();

    // Helpers
    function updateDateDisplay() {
      const today = new Date();
      let label = selectedDate.toLocaleDateString();
      if (selectedDate.toDateString() === today.toDateString()) label = "Today";
      document.getElementById('current-date-display').textContent = label;
    }
    function toggleDateDropdown() { document.getElementById('date-dropdown').classList.toggle('active'); }
    function changeDate(off) { selectedDate.setDate(selectedDate.getDate() + off); updateDateDisplay(); renderHabits(); document.getElementById('date-dropdown').classList.remove('active'); }
    function openAddModal() { document.getElementById('modal-habit').classList.add('active'); }
    function closeModal(id) { document.getElementById('modal-' + id).classList.remove('active'); }
    function switchView(v, el) { 
      document.querySelectorAll('.view-section').forEach(x => x.classList.remove('active'));
      document.getElementById('view-' + v).classList.add('active');
    }
    // Stub other functions for brevity in fallback mode
    function openHabitDetail(id) {}
    function renderStats() {}
    function renderGoals() {}
    function openGoalModal() { document.getElementById('modal-goal').classList.add('active'); }
    function saveGoal() {}
  </script>
</body>
</html>
