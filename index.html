<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Habits</title>
  
  <!-- SUPABASE LIBRARY -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* --- STYLES (Identical to before) --- */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --bg-color: #000000; --card-bg: #1C1C1E; --text-primary: #FFFFFF;
      --text-secondary: #8E8E93; --accent-color: #0A84FF; --success-color: #30D158;
      --danger-color: #FF453A; --separator: #38383A;
      --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    }
    body {
      background-color: var(--bg-color); color: var(--text-primary);
      font-family: var(--font-family); padding-bottom: 90px; overflow-x: hidden;
    }
    .view-section { display: none; padding-bottom: 20px; }
    .view-section.active { display: block; animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* Top Bar */
    .top-bar {
      display: flex; justify-content: space-between; align-items: flex-end;
      padding: 16px 20px 10px; position: sticky; top: 0;
      background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); z-index: 100;
    }
    .app-title { font-size: 34px; font-weight: 700; letter-spacing: -0.5px; }
    .top-actions { display: flex; align-items: center; gap: 16px; }

    /* Date Selector */
    .date-selector-container { position: relative; }
    .date-selector {
      color: var(--text-primary); font-size: 17px; font-weight: 600;
      display: flex; align-items: center; gap: 6px; cursor: pointer;
      background: rgba(255,255,255,0.1); padding: 6px 14px; border-radius: 20px;
    }
    .date-dropdown {
      position: absolute; top: 45px; right: 0;
      background: #2C2C2E; border-radius: 14px; width: 220px; padding: 8px;
      display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 200;
      border: 1px solid #38383A;
    }
    .date-dropdown.active { display: block; }
    .date-option {
      padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px;
      display: flex; justify-content: space-between;
    }
    .date-option:hover { background: #3A3A3C; }
    .date-option.selected { color: var(--accent-color); font-weight: 600; }
    .icon-btn { font-size: 22px; color: var(--accent-color); cursor: pointer; padding: 4px; }

    /* Habit List */
    .habit-list { padding: 10px 16px; display: flex; flex-direction: column; gap: 12px; }
    .habit-card {
      background-color: var(--card-bg); border-radius: 14px; padding: 16px;
      display: flex; align-items: center; justify-content: space-between; position: relative;
    }
    .habit-left { display: flex; align-items: center; gap: 14px; flex: 1; cursor: pointer; }
    .habit-icon {
      font-size: 24px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05); border-radius: 12px;
    }
    .habit-details { display: flex; flex-direction: column; gap: 4px; }
    .habit-name { font-size: 17px; font-weight: 600; }
    .habit-meta { font-size: 13px; color: var(--text-secondary); }
    .check-circle {
      width: 30px; height: 30px; border-radius: 50%; border: 2px solid #48484A;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .check-circle.completed {
      background-color: var(--success-color); border-color: var(--success-color);
      box-shadow: 0 0 15px rgba(48, 209, 88, 0.2);
    }
    .check-circle.completed::after { content: '‚úì'; font-size: 18px; color: black; font-weight: 800; }

    /* Stats View */
    .stats-container { padding: 16px; }
    .stats-card-large {
      background-color: var(--card-bg); border-radius: 18px; padding: 24px 20px;
      margin-bottom: 16px; text-align: center;
    }
    .gauge-wrapper { position: relative; width: 180px; height: 90px; margin: 0 auto 10px; overflow: hidden; }
    .gauge-arc-bg {
      position: absolute; top: 0; left: 0; width: 180px; height: 180px;
      border-radius: 50%; border: 16px solid #2C2C2E; box-sizing: border-box;
    }
    .gauge-arc-fill {
      position: absolute; top: 0; left: 0; width: 180px; height: 180px;
      border-radius: 50%; border: 16px solid transparent;
      border-top-color: var(--accent-color); border-right-color: var(--accent-color);
      box-sizing: border-box; transform: rotate(-45deg); transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .gauge-label-main { font-size: 42px; font-weight: 800; color: white; margin-top: -10px; }
    .gauge-label-sub { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .stat-box {
      background-color: var(--card-bg); border-radius: 16px; padding: 16px;
      display: flex; flex-direction: column; justify-content: space-between; height: 110px;
    }
    .stat-label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--success-color); }
    .heat-map-container { overflow-x: auto; padding-bottom: 10px; }
    .heat-map { display: grid; grid-template-rows: repeat(7, 1fr); grid-auto-flow: column; gap: 4px; height: 140px; }
    .heat-dot { width: 14px; height: 14px; background-color: #2C2C2E; border-radius: 4px; }
    .heat-dot.active { background-color: var(--accent-color); }

    /* Goals View */
    .goal-card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 12px; }
    .goal-header { display: flex; justify-content: space-between; margin-bottom: 16px; align-items: flex-start; }
    .goal-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .goal-date { font-size: 13px; color: var(--text-secondary); }
    .progress-track { background: #2C2C2E; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 12px; }
    .progress-bar { height: 100%; background: var(--accent-color); border-radius: 5px; transition: width 0.3s ease; }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      background-color: rgba(28, 28, 30, 0.85); backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px); border-radius: 35px; padding: 6px 8px;
      display: flex; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 1000;
      border: 0.5px solid rgba(255,255,255,0.15);
    }
    .nav-item {
      width: 50px; height: 50px; border-radius: 25px;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; color: #8E8E93; cursor: pointer; transition: all 0.2s ease;
    }
    .nav-item.active { background-color: #3A3A3C; color: white; }

    /* Modals */
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: black; z-index: 2000; display: none; flex-direction: column;
      animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .modal.active { display: flex; }
    .modal-header {
      padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
      background: #1C1C1E; border-bottom: 0.5px solid #2C2C2E;
    }
    .modal-content { padding: 20px; flex: 1; overflow-y: auto; }
    .modal-action { color: var(--accent-color); font-size: 17px; cursor: pointer; }
    .modal-action.danger { color: var(--danger-color); }
    .form-group { background: #2C2C2E; border-radius: 12px; padding: 0 16px; margin-bottom: 24px; }
    .form-row { display: flex; align-items: center; padding: 16px 0; border-bottom: 0.5px solid #38383A; }
    .form-row:last-child { border-bottom: none; }
    .form-input { background: transparent; border: none; color: white; font-size: 17px; flex: 1; margin-left: 12px; outline: none; }
    select:focus, input:focus { outline: none; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* Habit Detail View */
    .habit-detail-view {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: black; z-index: 1500; display: none; flex-direction: column;
      animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .habit-detail-view.active { display: flex; }
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
  </style>
</head>
<body>

  <!-- VIEW: HABITS -->
  <div id="view-habits" class="view-section active">
    <div class="top-bar">
      <div class="app-title">Habits</div>
      <div class="top-actions">
        <div class="date-selector-container">
          <div class="date-selector" onclick="toggleDateDropdown()">
            <span id="current-date-display">Today</span> <span style="font-size:12px; opacity:0.7;">‚ñº</span>
          </div>
          <div class="date-dropdown" id="date-dropdown">
            <div class="date-option" onclick="changeDate(-1)">Yesterday</div>
            <div class="date-option selected" onclick="changeDate(0)">Today</div>
            <div class="date-option" onclick="changeDate(1)">Tomorrow</div>
            <div style="height:1px; background:#38383A; margin:8px 0;"></div>
            <div class="date-option" style="color:var(--accent-color)">Pick a Date...</div>
          </div>
        </div>
        <div class="icon-btn" onclick="openAddModal()">‚ûï</div>
      </div>
    </div>
    <div class="habit-list" id="habits-container">
      <div style="text-align:center; margin-top:40px; color:#8E8E93;" id="loading-msg">Connecting to cloud...</div>
    </div>
  </div>

  <!-- VIEW: STATS -->
  <div id="view-stats" class="view-section stats-container">
    <div class="app-title" style="margin-bottom: 20px;">Statistics</div>
    <div class="stats-card-large">
      <div class="gauge-wrapper">
        <div class="gauge-arc-bg"></div>
        <div class="gauge-arc-fill" id="gauge-fill"></div>
      </div>
      <div class="gauge-label-main" id="stats-percentage">0%</div>
      <div class="gauge-label-sub">Daily Completion</div>
    </div>
    <div class="grid-2">
      <div class="stat-box">
        <div class="stat-label">Habit Accuracy</div>
        <div class="stat-value" id="stats-accuracy">0%</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Consistency</div>
        <div class="stat-value" style="color: var(--accent-color);" id="stats-consistency">0%</div>
      </div>
    </div>
    <div class="stats-card-large" style="text-align: left;">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
        <span style="font-weight:600;">Activity Log</span>
        <span style="color:var(--text-secondary); font-size:13px;">Last 60 Days</span>
      </div>
      <div class="heat-map-container">
        <div class="heat-map" id="heat-map"></div>
      </div>
    </div>
  </div>

  <!-- VIEW: GOALS -->
  <div id="view-goals" class="view-section" style="padding: 20px;">
    <div class="top-bar" style="padding: 0 0 20px 0;">
      <div class="app-title">Goals</div>
      <div class="icon-btn" onclick="openGoalModal()">‚ûï</div>
    </div>
    <div id="goals-container">
      <div style="color:#8E8E93; text-align:center; margin-top:40px;">Loading goals...</div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchView('habits', this)">üìÖ</div>
    <div class="nav-item" onclick="switchView('stats', this)">üìä</div>
    <div class="nav-item" onclick="switchView('goals', this)">üéØ</div>
  </div>

  <!-- MODAL: ADD/EDIT HABIT -->
  <div id="modal-habit" class="modal">
    <div class="modal-header">
      <div class="modal-action" onclick="closeModal('habit')">Cancel</div>
      <div class="modal-title" id="habit-modal-title">New Habit</div>
      <div class="modal-action" style="font-weight:600;" onclick="saveHabit()">Save</div>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <div class="form-row"><span>üìù</span><input type="text" id="habit-name" class="form-input" placeholder="Name" /></div>
        <div class="form-row"><span>üìÑ</span><input type="text" id="habit-desc" class="form-input" placeholder="Description" /></div>
      </div>
      <div class="form-group">
        <div class="form-row" style="justify-content: space-between;">
          <span>Icon</span><input type="text" id="habit-icon" class="form-input" value="üìö" style="text-align:right; width:50px;" />
        </div>
        <div class="form-row" style="justify-content: space-between;">
          <span>Color</span>
          <select id="habit-color" style="background:none; border:none; color:white; text-align:right; font-size:16px;">
            <option value="#0A84FF">Blue</option>
            <option value="#FF453A">Red</option>
            <option value="#30D158">Green</option>
            <option value="#FF9F0A">Orange</option>
            <option value="#BF5AF2">Purple</option>
          </select>
        </div>
      </div>
      <div class="form-group" id="delete-section" style="display:none; margin-top:30px; background:rgba(255, 69, 58, 0.1);">
        <div class="form-row" style="justify-content: center; border:none;">
          <span class="modal-action danger" onclick="deleteHabit()" style="width:100%; text-align:center;">Delete Habit</span>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: ADD GOAL -->
  <div id="modal-goal" class="modal">
    <div class="modal-header">
      <div class="modal-action" onclick="closeModal('goal')">Cancel</div>
      <div class="modal-title">New Goal</div>
      <div class="modal-action" style="font-weight:600;" onclick="saveGoal()">Save</div>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <div class="form-row"><span>üéØ</span><input type="text" id="goal-title" class="form-input" placeholder="Goal Title" /></div>
        <div class="form-row"><span>üìÖ</span><input type="date" id="goal-date" class="form-input" style="color-scheme: dark;" /></div>
      </div>
    </div>
  </div>

  <!-- VIEW: HABIT DETAIL -->
  <div id="view-habit-detail" class="habit-detail-view">
    <div class="modal-header">
      <div class="modal-action" onclick="closeHabitDetail()">‚Üê Back</div>
      <div class="modal-title">Details</div>
      <div class="modal-action" onclick="editCurrentHabit()">Edit</div>
    </div>
    <div class="modal-content">
      <div class="stats-card-large" style="padding: 30px;">
        <div style="font-size: 50px; margin-bottom: 16px;" id="detail-icon">üìö</div>
        <div style="font-size: 28px; font-weight: 700;" id="detail-name">Reading</div>
        <div style="color: var(--text-secondary); margin-top: 6px; font-size: 16px;" id="detail-desc">5 pages</div>
      </div>
      <div class="grid-2">
        <div class="stat-box">
          <div class="stat-label">Current Streak</div>
          <div class="stat-value" id="detail-streak">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total</div>
          <div class="stat-value" style="color: var(--accent-color);" id="detail-total">0</div>
        </div>
      </div>
      <div class="stats-card-large" style="text-align: left;">
        <div style="font-weight:600; margin-bottom:12px;">History</div>
        <div class="heat-map-container">
          <div class="heat-map" id="detail-heatmap" style="grid-template-rows: repeat(7, 1fr);"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 1) CONFIGURATION
    const SUPABASE_URL = 'https://dssywydywiqukaagisce.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzc3l3eWR5d2lxdWthYWdpc2NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3ODQzMjksImV4cCI6MjA4NjM2MDMyOX0.nGzvYHRWGKWPWc8wsjt19Xfx9btCZkyrz-YueksnLkI';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 2) STATE
    let habits = [];
    let goals = [];
    let completions = []; 
    let selectedDate = new Date();
    let currentHabitId = null;
    let userId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log("Creating user...");
        // Auto-login logic
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          const fakeEmail = `user${Date.now()}@test.com`;
          const { data, error } = await supabase.auth.signUp({
            email: fakeEmail,
            password: 'password123'
          });
          if (error) throw error;
          userId = data.user?.id;
        } else {
          userId = user.id;
        }
        
        console.log("User ID:", userId);
        await loadData();
        updateDateDisplay();

      } catch (err) {
        console.error("Critical Error:", err);
        // Fallback: If network fails, show empty UI so it's not stuck on loading
        document.getElementById('habits-container').innerHTML = 
          `<div style="text-align:center; margin-top:40px; color:#FF453A;">
             Connection Failed.<br><span style="font-size:12px; opacity:0.7">${err.message}</span>
           </div>`;
      }
    });

    async function loadData() {
      // Parallel Fetch
      const [habitsResult, compResult, goalsResult] = await Promise.all([
        supabase.from('habits').select('*').order('created_at'),
        supabase.from('completions').select('*'),
        supabase.from('goals').select('*').order('created_at')
      ]);

      if (habitsResult.error) throw habitsResult.error;
      
      habits = habitsResult.data || [];
      completions = compResult.data || [];
      goals = goalsResult.data || [];

      renderHabits();
      renderStats();
      renderGoals();
    }

    // 3) CORE LOGIC
    function renderHabits() {
      const container = document.getElementById('habits-container');
      container.innerHTML = '';
      const dateKey = selectedDate.toISOString().split('T')[0];

      if (habits.length === 0) {
        container.innerHTML = '<div style="text-align:center; margin-top:40px; color:#8E8E93;">No habits yet. Tap + to add one.</div>';
        return;
      }

      habits.forEach(habit => {
        const isCompleted = completions.some(c => c.habit_id === habit.id && c.completed_at.startsWith(dateKey));
        
        const div = document.createElement('div');
        div.className = 'habit-card';
        div.innerHTML = `
          <div class="habit-left" onclick="openHabitDetail(${habit.id})">
            <div class="habit-icon">${habit.icon || '‚ú®'}</div>
            <div class="habit-details">
              <div class="habit-name">${habit.name}</div>
              <div class="habit-meta">${habit.description || ''}</div>
            </div>
          </div>
          <div class="check-circle ${isCompleted ? 'completed' : ''}" 
               onclick="toggleHabit(${habit.id}, ${isCompleted})"
               style="${isCompleted ? 'background-color:#0A84FF; border-color:#0A84FF' : ''}">
          </div>
        `;
        container.appendChild(div);
      });
    }

    async function toggleHabit(habitId, isCurrentlyCompleted) {
      const dateKey = selectedDate.toISOString().split('T')[0];
      
      if (isCurrentlyCompleted) {
        // Remove locally first
        const record = completions.find(c => c.habit_id === habitId && c.completed_at.startsWith(dateKey));
        if (record) {
          completions = completions.filter(c => c.id !== record.id);
          renderHabits(); renderStats();
          await supabase.from('completions').delete().eq('id', record.id);
        }
      } else {
        // Add locally first
        const newComp = {
          habit_id: habitId,
          user_id: userId,
          completed_at: new Date(selectedDate).toISOString()
        };
        const tempId = Date.now();
        completions.push({ ...newComp, id: tempId });
        
        if (navigator.vibrate) navigator.vibrate(10);
        renderHabits(); renderStats();

        const { data } = await supabase.from('completions').insert(newComp).select();
        if (data) {
          // Update temp ID with real ID
          completions = completions.filter(c => c.id !== tempId);
          completions.push(data[0]);
        }
      }
    }

    // 4) ADD / EDIT / DELETE
    async function saveHabit() {
      const name = document.getElementById('habit-name').value;
      const desc = document.getElementById('habit-desc').value;
      const icon = document.getElementById('habit-icon').value;
      
      if (!name) return;

      const habitData = { name, description: desc, icon: icon, user_id: userId };

      if (currentHabitId) {
        const { error } = await supabase.from('habits').update(habitData).eq('id', currentHabitId);
        if (!error) {
           const idx = habits.findIndex(h => h.id === currentHabitId);
           if (idx !== -1) habits[idx] = { ...habits[idx], ...habitData };
        }
      } else {
        const { data, error } = await supabase.from('habits').insert(habitData).select();
        if (!error && data) habits.push(data[0]);
      }
      closeModal('habit');
      renderHabits();
    }

    async function deleteHabit() {
      if (confirm("Delete this habit?")) {
        await supabase.from('habits').delete().eq('id', currentHabitId);
        habits = habits.filter(h => h.id !== currentHabitId);
        closeModal('habit');
        renderHabits();
      }
    }

    async function saveGoal() {
      const title = document.getElementById('goal-title').value;
      const date = document.getElementById('goal-date').value;
      
      if (title) {
        const goalData = { title, target_date: date, user_id: userId, progress: 0 };
        const { data } = await supabase.from('goals').insert(goalData).select();
        if (data) goals.push(data[0]);
        renderGoals();
        closeModal('goal');
      }
    }

    // 5) STATS & GOALS
    function renderStats() {
      const dateKey = new Date().toISOString().split('T')[0];
      const completedToday = completions.filter(c => c.completed_at.startsWith(dateKey)).length;
      const total = habits.length;
      const pct = total === 0 ? 0 : Math.round((completedToday / total) * 100);

      document.getElementById('stats-percentage').textContent = pct + '%';
      const deg = -225 + ((pct / 100) * 180);
      document.getElementById('gauge-fill').style.transform = `rotate(${deg}deg)`;
      document.getElementById('stats-accuracy').textContent = pct + '%';
      
      renderHeatmap();
    }

    function renderHeatmap() {
      const container = document.getElementById('heat-map');
      container.innerHTML = '';
      for (let i = 0; i < 70; i++) {
        const d = new Date();
        d.setDate(d.getDate() - (69 - i));
        const dateStr = d.toISOString().split('T')[0];
        const count = completions.filter(c => c.completed_at.startsWith(dateStr)).length;
        
        const dot = document.createElement('div');
        dot.className = 'heat-dot';
        if (count > 0) dot.classList.add('active');
        container.appendChild(dot);
      }
    }
    
    function renderGoals() {
      const container = document.getElementById('goals-container');
      container.innerHTML = '';
      if (goals.length === 0) {
        container.innerHTML = '<div style="color:#8E8E93; text-align:center; margin-top:40px;">No goals yet.</div>';
        return;
      }
      goals.forEach(g => {
        const div = document.createElement('div');
        div.className = 'goal-card';
        div.innerHTML = `
          <div class="goal-header">
            <div><div class="goal-title">${g.title}</div><div class="goal-date">Target: ${g.target_date || ''}</div></div>
            <div style="font-weight:700; color:var(--accent-color);">${g.progress || 0}%</div>
          </div>
          <div class="progress-track"><div class="progress-bar" style="width: ${g.progress || 0}%"></div></div>
          <div style="margin-top:16px; text-align:right;">
             <div onclick="updateGoal(${g.id}, 10)" style="display:inline-block; background:#3A3A3C; color:white; padding:8px 16px; border-radius:8px; font-weight:600; cursor:pointer;">+10% Track</div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    async function updateGoal(id, amount) {
      const g = goals.find(x => x.id === id);
      const newProg = Math.min(100, (g.progress || 0) + amount);
      g.progress = newProg;
      renderGoals();
      await supabase.from('goals').update({ progress: newProg }).eq('id', id);
    }

    // 6) HELPER FUNCTIONS
    function openAddModal() {
      currentHabitId = null;
      document.getElementById('habit-modal-title').textContent = "New Habit";
      document.getElementById('habit-name').value = "";
      document.getElementById('habit-desc').value = "";
      document.getElementById('delete-section').style.display = 'none';
      document.getElementById('modal-habit').classList.add('active');
    }
    function editCurrentHabit() {
      const habit = habits.find(h => h.id === currentHabitId);
      document.getElementById('habit-modal-title').textContent = "Edit Habit";
      document.getElementById('habit-name').value = habit.name;
      document.getElementById('habit-desc').value = habit.description;
      document.getElementById('habit-icon').value = habit.icon;
      document.getElementById('delete-section').style.display = 'block';
      closeHabitDetail();
      document.getElementById('modal-habit').classList.add('active');
    }
    function openHabitDetail(id) {
      currentHabitId = id;
      const habit = habits.find(h => h.id === id);
      document.getElementById('detail-name').textContent = habit.name;
      document.getElementById('detail-desc').textContent = habit.description;
      document.getElementById('detail-icon').textContent = habit.icon;
      const total = completions.filter(c => c.habit_id === id).length;
      document.getElementById('detail-total').textContent = total;
      document.getElementById('detail-streak').textContent = "üî• " + total;
      document.getElementById('view-habit-detail').classList.add('active');
    }
    function toggleDateDropdown() { document.getElementById('date-dropdown').classList.toggle('active'); }
    function changeDate(offset) {
      selectedDate.setDate(selectedDate.getDate() + offset);
      updateDateDisplay();
      document.getElementById('date-dropdown').classList.remove('active');
      renderHabits();
    }
    function updateDateDisplay() {
      const today = new Date();
      let label = selectedDate.toLocaleDateString();
      if (selectedDate.toDateString() === today.toDateString()) label = "Today";
      else if (selectedDate.getDate() === today.getDate() - 1) label = "Yesterday";
      else if (selectedDate.getDate() === today.getDate() + 1) label = "Tomorrow";
      document.getElementById('current-date-display').textContent = label;
    }
    function openGoalModal() { document.getElementById('modal-goal').classList.add('active'); }
    function closeModal(type) { document.getElementById('modal-' + type).classList.remove('active'); }
    function closeHabitDetail() { document.getElementById('view-habit-detail').classList.remove('active'); }
    function switchView(viewName, el) {
      document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('view-' + viewName).classList.add('active');
      el.classList.add('active');
    }
  </script>
</body>
</html>
