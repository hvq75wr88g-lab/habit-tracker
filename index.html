<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Habits</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --bg-color: #000000; --card-bg: #1C1C1E; --text-primary: #FFFFFF;
      --text-secondary: #8E8E93; --accent-color: #0A84FF; --success-color: #30D158;
      --danger-color: #FF453A; --separator: #38383A;
      --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    }
    body { background-color: var(--bg-color); color: var(--text-primary); font-family: var(--font-family); padding-bottom: 90px; overflow-x: hidden; }
    .view-section { display: none; padding-bottom: 20px; }
    .view-section.active { display: block; animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .top-bar { display: flex; justify-content: space-between; align-items: flex-end; padding: 16px 20px 10px; position: sticky; top: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); z-index: 100; }
    .app-title { font-size: 34px; font-weight: 700; letter-spacing: -0.5px; }
    .top-actions { display: flex; align-items: center; gap: 16px; }
    .date-selector-container { position: relative; }
    .date-selector { color: var(--text-primary); font-size: 17px; font-weight: 600; display: flex; align-items: center; gap: 6px; cursor: pointer; background: rgba(255,255,255,0.1); padding: 6px 14px; border-radius: 20px; }
    .date-dropdown { position: absolute; top: 45px; right: 0; background: #2C2C2E; border-radius: 14px; width: 220px; padding: 8px; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 200; border: 1px solid #38383A; }
    .date-dropdown.active { display: block; }
    .date-option { padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; justify-content: space-between; }
    .date-option:hover { background: #3A3A3C; }
    .date-option.selected { color: var(--accent-color); font-weight: 600; }
    .icon-btn { font-size: 22px; color: var(--accent-color); cursor: pointer; padding: 4px; }
    .habit-list { padding: 10px 16px; display: flex; flex-direction: column; gap: 12px; }
    .habit-card { background-color: var(--card-bg); border-radius: 14px; padding: 16px; display: flex; align-items: center; justify-content: space-between; position: relative; }
    .habit-left { display: flex; align-items: center; gap: 14px; flex: 1; cursor: pointer; }
    .habit-icon { font-size: 24px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 12px; }
    .habit-details { display: flex; flex-direction: column; gap: 4px; }
    .habit-name { font-size: 17px; font-weight: 600; }
    .habit-meta { font-size: 13px; color: var(--text-secondary); }
    .check-circle { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #48484A; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); flex-shrink: 0; }
    .check-circle.completed { background-color: var(--success-color); border-color: var(--success-color); box-shadow: 0 0 15px rgba(48, 209, 88, 0.2); }
    .check-circle.completed::after { content: '\2713'; font-size: 18px; color: black; font-weight: 800; }
    .week-badge { font-size: 11px; color: var(--text-secondary); background: rgba(255,255,255,0.06); padding: 2px 8px; border-radius: 10px; margin-left: 8px; white-space: nowrap; }
    .week-badge.complete { color: var(--success-color); background: rgba(48, 209, 88, 0.1); }
    .stats-container { padding: 16px; }
    .stats-card-large { background-color: var(--card-bg); border-radius: 18px; padding: 24px 20px; margin-bottom: 16px; text-align: center; }
    .gauge-wrapper { position: relative; width: 180px; height: 90px; margin: 0 auto 10px; overflow: hidden; }
    .gauge-arc-bg { position: absolute; top: 0; left: 0; width: 180px; height: 180px; border-radius: 50%; border: 16px solid #2C2C2E; box-sizing: border-box; }
    .gauge-arc-fill { position: absolute; top: 0; left: 0; width: 180px; height: 180px; border-radius: 50%; border: 16px solid transparent; border-top-color: var(--accent-color); border-right-color: var(--accent-color); box-sizing: border-box; transform: rotate(-45deg); transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .gauge-label-main { font-size: 42px; font-weight: 800; color: white; margin-top: -10px; }
    .gauge-label-sub { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .stat-box { background-color: var(--card-bg); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; justify-content: space-between; height: 110px; }
    .stat-label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--success-color); }
    .heat-map-container { overflow-x: auto; padding-bottom: 10px; }
    .heat-map { display: grid; grid-template-rows: repeat(7, 1fr); grid-auto-flow: column; gap: 4px; height: 140px; }
    .heat-dot { width: 14px; height: 14px; background-color: #2C2C2E; border-radius: 4px; }
    .heat-dot.active { background-color: var(--accent-color); }
    .goal-card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 12px; }
    .goal-header { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: flex-start; }
    .goal-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .goal-date { font-size: 13px; color: var(--text-secondary); }
    .progress-track { background: #2C2C2E; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 12px; }
    .progress-bar { height: 100%; background: var(--accent-color); border-radius: 5px; transition: width 0.3s ease; }
    .goal-checklist { margin-top: 14px; display: flex; flex-direction: column; gap: 8px; }
    .goal-check-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 0.5px solid #2C2C2E; font-size: 15px; }
    .goal-check-row:last-child { border-bottom: none; }
    .goal-check { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #48484A; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
    .goal-check.checked { background: var(--accent-color); border-color: var(--accent-color); }
    .goal-check.checked::after { content: '\2713'; font-size: 14px; color: white; font-weight: 800; }
    .goal-check-label { color: var(--text-secondary); font-size: 14px; }
    .goal-check-label.checked { color: white; text-decoration: line-through; text-decoration-color: #48484A; }
    .goal-actions { display: flex; gap: 10px; margin-top: 14px; justify-content: flex-end; }
    .goal-action-btn { background: #3A3A3C; color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
    .goal-action-btn.danger { background: rgba(255,69,58,0.15); color: var(--danger-color); }
    .bottom-nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background-color: rgba(28, 28, 30, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 35px; padding: 6px 8px; display: flex; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 1000; border: 0.5px solid rgba(255,255,255,0.15); }
    .nav-item { width: 50px; height: 50px; border-radius: 25px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #8E8E93; cursor: pointer; transition: all 0.2s ease; }
    .nav-item.active { background-color: #3A3A3C; color: white; }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: black; z-index: 2000; display: none; flex-direction: column; animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
    .modal.active { display: flex; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; background: #1C1C1E; border-bottom: 0.5px solid #2C2C2E; }
    .modal-content { padding: 20px; flex: 1; overflow-y: auto; }
    .modal-action { color: var(--accent-color); font-size: 17px; cursor: pointer; }
    .modal-action.danger { color: var(--danger-color); }
    .form-group { background: #2C2C2E; border-radius: 12px; padding: 0 16px; margin-bottom: 24px; }
    .form-row { display: flex; align-items: center; padding: 16px 0; border-bottom: 0.5px solid #38383A; }
    .form-row:last-child { border-bottom: none; }
    .form-input { background: transparent; border: none; color: white; font-size: 17px; flex: 1; margin-left: 12px; outline: none; }
    select:focus, input:focus { outline: none; }
    .habit-detail-view { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: black; z-index: 1500; display: none; flex-direction: column; animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .habit-detail-view.active { display: flex; }
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="view-habits" class="view-section active">
    <div class="top-bar">
      <div class="app-title">Habits</div>
      <div class="top-actions">
        <div class="date-selector-container">
          <div class="date-selector" onclick="toggleDateDropdown()">
            <span id="current-date-display">Today</span> <span style="font-size:12px; opacity:0.7;">‚ñº</span>
          </div>
          <div class="date-dropdown" id="date-dropdown">
            <div class="date-option" onclick="changeDate(-1)">Yesterday</div>
            <div class="date-option selected" onclick="changeDate(0)">Today</div>
            <div class="date-option" onclick="changeDate(1)">Tomorrow</div>
            <div style="height:1px; background:#38383A; margin:8px 0;"></div>
            <div class="date-option" style="color:var(--accent-color)">Pick a Date...</div>
          </div>
        </div>
        <div class="icon-btn" onclick="openAddModal()">+</div>
      </div>
    </div>
    <div class="habit-list" id="habits-container"></div>
  </div>

  <div id="view-stats" class="view-section stats-container">
    <div class="app-title" style="margin-bottom: 20px;">Statistics</div>
    <div class="stats-card-large">
      <div class="gauge-wrapper">
        <div class="gauge-arc-bg"></div>
        <div class="gauge-arc-fill" id="gauge-fill"></div>
      </div>
      <div class="gauge-label-main" id="stats-percentage">0%</div>
      <div class="gauge-label-sub">Weekly Completion</div>
    </div>
    <div class="grid-2">
      <div class="stat-box">
        <div class="stat-label">Habit Accuracy</div>
        <div class="stat-value" id="stats-accuracy">0%</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Consistency</div>
        <div class="stat-value" style="color: var(--accent-color);" id="stats-consistency">0%</div>
      </div>
    </div>
    <div class="stats-card-large" style="text-align: left;">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
        <span style="font-weight:600;">Activity Log</span>
        <span style="color:var(--text-secondary); font-size:13px;">Last 10 Weeks</span>
      </div>
      <div class="heat-map-container">
        <div class="heat-map" id="heat-map"></div>
      </div>
    </div>
  </div>

  <div id="view-goals" class="view-section" style="padding: 20px;">
    <div class="top-bar" style="padding: 0 0 20px 0;">
      <div class="app-title">Goals</div>
      <div class="icon-btn" onclick="openGoalModal()">+</div>
    </div>
    <div id="goals-container">
      <div style="color:#8E8E93; text-align:center; margin-top:40px;">No goals yet. Tap + to add one.</div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchView('habits', this)">üìÖ</div>
    <div class="nav-item" onclick="switchView('stats', this)">üìä</div>
    <div class="nav-item" onclick="switchView('goals', this)">üéØ</div>
  </div>

  <div id="modal-habit" class="modal">
    <div class="modal-header">
      <div class="modal-action" onclick="closeModal('habit')">Cancel</div>
      <div class="modal-title" id="habit-modal-title">New Habit</div>
      <div class="modal-action" style="font-weight:600;" onclick="saveHabit()">Save</div>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <div class="form-row">
          <span>‚úèÔ∏è</span>
          <input type="text" id="habit-name" class="form-input" placeholder="Name" />
        </div>
        <div class="form-row">
          <span>üìÑ</span>
          <input type="text" id="habit-desc" class="form-input" placeholder="Description (e.g. 5 pages)" />
        </div>
      </div>
      <div class="form-group">
        <div class="form-row" style="justify-content: space-between;">
          <span>Icon</span>
          <input type="text" id="habit-icon" class="form-input" value="üìö" style="text-align:right; width:50px;" />
        </div>
        <div class="form-row" style="justify-content: space-between;">
          <span>Color</span>
          <select id="habit-color" style="background:none; border:none; color:white; text-align:right; font-size:16px;">
            <option value="#0A84FF">Blue</option>
            <option value="#FF453A">Red</option>
            <option value="#30D158">Green</option>
            <option value="#FF9F0A">Orange</option>
            <option value="#BF5AF2">Purple</option>
            <option value="#FFD60A">Yellow</option>
          </select>
        </div>
        <div class="form-row" style="justify-content: space-between;">
          <span>Frequency</span>
          <select id="habit-frequency" style="background:none; border:none; color:white; text-align:right; font-size:16px;">
            <option value="7">Every day (7/week)</option>
            <option value="6">6 times / week</option>
            <option value="5">5 times / week</option>
            <option value="4">4 times / week</option>
            <option value="3">3 times / week</option>
            <option value="2">2 times / week</option>
            <option value="1">1 time / week</option>
          </select>
        </div>
      </div>
      <div class="form-group" id="delete-section" style="display:none; margin-top:30px; background:rgba(255,69,58,0.1);">
        <div class="form-row" style="justify-content: center; border:none;">
          <span class="modal-action danger" onclick="deleteHabit()" style="width:100%; text-align:center; padding:4px;">Delete Habit</span>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-goal" class="modal">
    <div class="modal-header">
      <div class="modal-action" onclick="closeModal('goal')">Cancel</div>
      <div class="modal-title" id="goal-modal-title">New Goal</div>
      <div class="modal-action" style="font-weight:600;" onclick="saveGoal()">Save</div>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <div class="form-row">
          <span>üéØ</span>
          <input type="text" id="goal-title" class="form-input" placeholder="Goal Title" />
        </div>
        <div class="form-row">
          <span>üìÖ</span>
          <input type="date" id="goal-date" class="form-input" style="color-scheme: dark;" />
        </div>
      </div>
      <div class="form-group" id="goal-delete-section" style="display:none; margin-top:30px; background:rgba(255,69,58,0.1);">
        <div class="form-row" style="justify-content: center; border:none;">
          <span class="modal-action danger" onclick="deleteGoal()" style="width:100%; text-align:center; padding:4px;">Delete Goal</span>
        </div>
      </div>
    </div>
  </div>

  <div id="view-habit-detail" class="habit-detail-view">
    <div class="modal-header">
      <div class="modal-action" onclick="closeHabitDetail()">‚Üê Back</div>
      <div class="modal-title" id="detail-title">Habit Details</div>
      <div class="modal-action" onclick="editCurrentHabit()">Edit</div>
    </div>
    <div class="modal-content">
      <div class="stats-card-large" style="padding: 30px;">
        <div style="font-size: 50px; margin-bottom: 16px;" id="detail-icon">üìö</div>
        <div style="font-size: 28px; font-weight: 700;" id="detail-name">Reading</div>
        <div style="color: var(--text-secondary); margin-top: 6px; font-size: 16px;" id="detail-desc">5 pages</div>
        <div style="color: var(--text-secondary); margin-top: 8px; font-size: 14px;" id="detail-freq"></div>
      </div>
      <div class="grid-2">
        <div class="stat-box">
          <div class="stat-label">Current Streak</div>
          <div class="stat-value" id="detail-streak">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total Completions</div>
          <div class="stat-value" style="color: var(--accent-color);" id="detail-total">0</div>
        </div>
      </div>
      <div class="stats-card-large" style="text-align: left;">
        <div style="font-weight:600; margin-bottom:12px;">History</div>
        <div class="heat-map-container">
          <div class="heat-map" id="detail-heatmap" style="grid-template-rows: repeat(7, 1fr);"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===================== DATA STORE =====================
    var habits = [
      { id: 1, name: "Reading", desc: "5 pages", icon: "üìö", color: "#FF453A", frequency: 7, completions: [] },
      { id: 2, name: "Drink Water", desc: "3000 ml", icon: "üíß", color: "#0A84FF", frequency: 7, completions: [] },
      { id: 3, name: "Exercise", desc: "60 mins", icon: "üèãÔ∏è", color: "#FF9F0A", frequency: 7, completions: [] }
    ];
    var goals = [];
    var selectedDate = new Date();
    var currentHabitId = null;
    var currentGoalId = null;

    // ===================== HELPER: LOCAL DATE STRING (YYYY-MM-DD) =====================
    // CRITICAL: Always use local timezone, never UTC, to avoid off-by-one day bugs
    function localDateStr(d) {
      var y = d.getFullYear();
      var m = String(d.getMonth() + 1).padStart(2, '0');
      var day = String(d.getDate()).padStart(2, '0');
      return y + '-' + m + '-' + day;
    }

    // ===================== INIT =====================
    document.addEventListener('DOMContentLoaded', function() {
      renderHabits();
      renderStats();
      renderGoals();
      updateDateDisplay();
    });

    // ===================== WEEK HELPERS =====================
    function getMonday(d) {
      var dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      var day = dt.getDay();
      var diff = day === 0 ? -6 : 1 - day;
      dt.setDate(dt.getDate() + diff);
      return dt;
    }

    function weekCompletions(habit, d) {
      var mon = getMonday(d);
      var sun = new Date(mon);
      sun.setDate(sun.getDate() + 6);
      sun.setHours(23,59,59,999);
      var count = 0;
      for (var i = 0; i < habit.completions.length; i++) {
        var cd = new Date(habit.completions[i]);
        if (cd >= mon && cd <= sun) count++;
      }
      return count;
    }

    // ===================== HABITS RENDERING =====================
    function renderHabits() {
      var container = document.getElementById('habits-container');
      container.innerHTML = '';
      var dateKey = selectedDate.toDateString();

      habits.forEach(function(habit) {
        var isCompleted = habit.completions.indexOf(dateKey) !== -1;
        var weekCount = weekCompletions(habit, selectedDate);
        var weekTarget = habit.frequency || 7;
        var weekMet = weekCount >= weekTarget;

        var div = document.createElement('div');
        div.className = 'habit-card';
        div.innerHTML =
          '<div class="habit-left" onclick="openHabitDetail(' + habit.id + ')">' +
            '<div class="habit-icon">' + habit.icon + '</div>' +
            '<div class="habit-details">' +
              '<div class="habit-name">' + habit.name + '</div>' +
              '<div class="habit-meta">' + habit.desc +
                (weekTarget < 7 ? ' <span class="week-badge ' + (weekMet ? 'complete' : '') + '">' + weekCount + '/' + weekTarget + ' this week</span>' : '') +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="check-circle ' + (isCompleted ? 'completed' : '') + '"' +
               ' onclick="toggleHabit(' + habit.id + ')"' +
               ' style="' + (isCompleted ? 'background-color:' + habit.color + '; border-color:' + habit.color : '') + '">' +
          '</div>';
        container.appendChild(div);
      });
    }

    function toggleHabit(id) {
      var habit = habits.find(function(h) { return h.id === id; });
      var dateKey = selectedDate.toDateString();

      if (habit.completions.indexOf(dateKey) !== -1) {
        habit.completions = habit.completions.filter(function(d) { return d !== dateKey; });
      } else {
        habit.completions.push(dateKey);
        if (navigator.vibrate) navigator.vibrate(10);
      }

      renderHabits();
      renderStats();
    }

    // ===================== DATE LOGIC =====================
    function toggleDateDropdown() {
      document.getElementById('date-dropdown').classList.toggle('active');
    }

    function changeDate(offset) {
      selectedDate.setDate(selectedDate.getDate() + offset);
      updateDateDisplay();
      document.getElementById('date-dropdown').classList.remove('active');
      renderHabits();
    }

    function updateDateDisplay() {
      var today = new Date();
      var label = selectedDate.toLocaleDateString();
      if (selectedDate.toDateString() === today.toDateString()) label = "Today";
      else if (selectedDate.getDate() === today.getDate() - 1 && selectedDate.getMonth() === today.getMonth()) label = "Yesterday";
      else if (selectedDate.getDate() === today.getDate() + 1 && selectedDate.getMonth() === today.getMonth()) label = "Tomorrow";
      document.getElementById('current-date-display').textContent = label;
      document.querySelectorAll('.date-option').forEach(function(el) { el.classList.remove('selected'); });
      if (label === "Today") document.querySelectorAll('.date-option')[1].classList.add('selected');
    }

    // ===================== ADD / EDIT / DELETE HABIT =====================
    function openAddModal() {
      currentHabitId = null;
      document.getElementById('habit-modal-title').textContent = "New Habit";
      document.getElementById('habit-name').value = "";
      document.getElementById('habit-desc').value = "";
      document.getElementById('habit-icon').value = "üìö";
      document.getElementById('habit-color').value = "#0A84FF";
      document.getElementById('habit-frequency').value = "7";
      document.getElementById('delete-section').style.display = 'none';
      document.getElementById('modal-habit').classList.add('active');
    }

    function editCurrentHabit() {
      var habit = habits.find(function(h) { return h.id === currentHabitId; });
      document.getElementById('habit-modal-title').textContent = "Edit Habit";
      document.getElementById('habit-name').value = habit.name;
      document.getElementById('habit-desc').value = habit.desc;
      document.getElementById('habit-icon').value = habit.icon;
      document.getElementById('habit-color').value = habit.color;
      document.getElementById('habit-frequency').value = String(habit.frequency || 7);
      document.getElementById('delete-section').style.display = 'block';
      closeHabitDetail();
      document.getElementById('modal-habit').classList.add('active');
    }

    function saveHabit() {
      var name = document.getElementById('habit-name').value;
      var desc = document.getElementById('habit-desc').value;
      var icon = document.getElementById('habit-icon').value;
      var color = document.getElementById('habit-color').value;
      var frequency = parseInt(document.getElementById('habit-frequency').value);
      if (!name) return;

      if (currentHabitId) {
        var habit = habits.find(function(h) { return h.id === currentHabitId; });
        habit.name = name; habit.desc = desc; habit.icon = icon; habit.color = color; habit.frequency = frequency;
      } else {
        habits.push({ id: Date.now(), name: name, desc: desc, icon: icon, color: color, frequency: frequency, completions: [] });
      }
      closeModal('habit');
      renderHabits();
      renderStats();
    }

    function deleteHabit() {
      if (confirm("Delete this habit?")) {
        habits = habits.filter(function(h) { return h.id !== currentHabitId; });
        closeModal('habit');
        renderHabits();
        renderStats();
      }
    }

    function closeModal(type) {
      document.getElementById('modal-' + type).classList.remove('active');
    }

    // ===================== HABIT DETAIL =====================
    function openHabitDetail(id) {
      currentHabitId = id;
      var habit = habits.find(function(h) { return h.id === id; });

      document.getElementById('detail-name').textContent = habit.name;
      document.getElementById('detail-desc').textContent = habit.desc;
      document.getElementById('detail-icon').textContent = habit.icon;
      document.getElementById('detail-total').textContent = habit.completions.length;
      document.getElementById('detail-streak').textContent = calculateStreak(habit);

      var freq = habit.frequency || 7;
      document.getElementById('detail-freq').textContent = freq === 7 ? "Every day" : freq + " times per week";

      renderDetailHeatmap(habit);
      document.getElementById('view-habit-detail').classList.add('active');
    }

    function closeHabitDetail() {
      document.getElementById('view-habit-detail').classList.remove('active');
    }

    function calculateStreak(habit) {
      if (habit.completions.length === 0) return "0";
      var freq = habit.frequency || 7;

      if (freq === 7) {
        var streak = 0;
        var d = new Date();
        d.setHours(0,0,0,0);
        while (habit.completions.indexOf(d.toDateString()) !== -1) {
          streak++;
          d.setDate(d.getDate() - 1);
        }
        return "üî• " + streak;
      } else {
        var streak = 0;
        var checkDate = new Date();
        while (true) {
          var wc = weekCompletions(habit, checkDate);
          if (wc >= freq) {
            streak++;
            checkDate.setDate(checkDate.getDate() - 7);
          } else {
            break;
          }
        }
        return "üî• " + streak + (streak === 1 ? " week" : " weeks");
      }
    }

    // ===================== STATS =====================
    function renderStats() {
      var today = new Date();
      var totalTarget = 0;
      var totalDone = 0;
      habits.forEach(function(h) {
        var freq = h.frequency || 7;
        var wc = weekCompletions(h, today);
        totalTarget += freq;
        totalDone += Math.min(wc, freq);
      });

      var pct = totalTarget === 0 ? 0 : Math.round((totalDone / totalTarget) * 100);
      document.getElementById('stats-percentage').textContent = pct + '%';
      var deg = -225 + ((pct / 100) * 180);
      document.getElementById('gauge-fill').style.transform = 'rotate(' + deg + 'deg)';

      // ACCURACY: For daily habits, did you do it today? For weekly habits, did you hit target this week?
      var habitsOnTarget = 0;
      habits.forEach(function(h) {
        var freq = h.frequency || 7;
        if (freq === 7) {
          // Daily: check if completed today
          if (h.completions.indexOf(today.toDateString()) !== -1) habitsOnTarget++;
        } else {
          // Weekly: check if weekly target met
          if (weekCompletions(h, today) >= freq) habitsOnTarget++;
        }
      });
      var accuracy = habits.length === 0 ? 0 : Math.round((habitsOnTarget / habits.length) * 100);
      document.getElementById('stats-accuracy').textContent = accuracy + '%';

      // CONSISTENCY: % of last 4 weeks where all habits met their targets
      var consistentWeeks = 0;
      for (var w = 0; w < 4; w++) {
        var weekDate = new Date(today);
        weekDate.setDate(weekDate.getDate() - (w * 7));
        var allMet = true;
        for (var i = 0; i < habits.length; i++) {
          var h = habits[i];
          var freq = h.frequency || 7;
          if (freq === 7) {
            // For daily habits in a past week, check if all 7 days were completed
            var mon = getMonday(weekDate);
            var allDays = true;
            for (var d = 0; d < 7; d++) {
              var checkDay = new Date(mon);
              checkDay.setDate(checkDay.getDate() + d);
              if (checkDay > today) continue; // Don't count future days
              if (h.completions.indexOf(checkDay.toDateString()) === -1) {
                allDays = false;
                break;
              }
            }
            if (!allDays) { allMet = false; break; }
          } else {
            if (weekCompletions(h, weekDate) < freq) { allMet = false; break; }
          }
        }
        if (allMet && habits.length > 0) consistentWeeks++;
      }
      var consistency = habits.length === 0 ? 0 : Math.round((consistentWeeks / 4) * 100);
      document.getElementById('stats-consistency').textContent = consistency + '%';

      renderHeatmap();
    }

    function renderHeatmap() {
      var container = document.getElementById('heat-map');
      container.innerHTML = '';
      for (var i = 0; i < 70; i++) {
        var d = new Date();
        d.setDate(d.getDate() - (69 - i));
        var dateKey = d.toDateString();
        var done = habits.filter(function(h) { return h.completions.indexOf(dateKey) !== -1; }).length;
        var active = done > 0 && done >= habits.length / 2;
        var dot = document.createElement('div');
        dot.className = 'heat-dot';
        if (active) dot.classList.add('active');
        container.appendChild(dot);
      }
    }

    function renderDetailHeatmap(habit) {
      var container = document.getElementById('detail-heatmap');
      container.innerHTML = '';
      for (var i = 0; i < 60; i++) {
        var d = new Date();
        d.setDate(d.getDate() - (59 - i));
        var active = habit.completions.indexOf(d.toDateString()) !== -1;
        var dot = document.createElement('div');
        dot.className = 'heat-dot';
        if (active) dot.classList.add('active');
        container.appendChild(dot);
      }
    }

    // ===================== GOALS =====================
    function openGoalModal(editId) {
      currentGoalId = editId || null;

      if (currentGoalId) {
        var goal = goals.find(function(g) { return g.id === currentGoalId; });
        document.getElementById('goal-modal-title').textContent = "Edit Goal";
        document.getElementById('goal-title').value = goal.title;
        document.getElementById('goal-date').value = goal.date || '';
        document.getElementById('goal-delete-section').style.display = 'block';
      } else {
        document.getElementById('goal-modal-title').textContent = "New Goal";
        document.getElementById('goal-title').value = '';
        document.getElementById('goal-date').value = '';
        document.getElementById('goal-delete-section').style.display = 'none';
      }

      document.getElementById('modal-goal').classList.add('active');
    }

    function saveGoal() {
      var title = document.getElementById('goal-title').value;
      var date = document.getElementById('goal-date').value;
      if (!title || !date) return;

      if (currentGoalId) {
        var goal = goals.find(function(g) { return g.id === currentGoalId; });
        goal.title = title;
        goal.date = date;
        goal.checkDays = buildCheckDays(goal.startDate, date);
        var validDays = new Set(goal.checkDays);
        goal.checked = (goal.checked || []).filter(function(d) { return validDays.has(d); });
      } else {
        var startDate = localDateStr(new Date());
        var checkDays = buildCheckDays(startDate, date);
        goals.push({
          id: Date.now(), title: title, date: date, startDate: startDate,
          checkDays: checkDays, checked: []
        });
      }

      renderGoals();
      closeModal('goal');
    }

    function deleteGoal() {
      if (confirm("Delete this goal?")) {
        goals = goals.filter(function(g) { return g.id !== currentGoalId; });
        closeModal('goal');
        renderGoals();
      }
    }

    function buildCheckDays(startStr, endStr) {
      var days = [];
      // Parse as local dates (add T12:00 to avoid UTC midnight issues)
      var start = new Date(startStr + 'T12:00:00');
      var end = new Date(endStr + 'T12:00:00');
      var d = new Date(start);
      while (d <= end) {
        days.push(localDateStr(d));
        d.setDate(d.getDate() + 1);
      }
      return days;
    }

    function toggleGoalDay(goalId, day) {
      var goal = goals.find(function(g) { return g.id === goalId; });
      if (goal.checked.indexOf(day) !== -1) {
        goal.checked = goal.checked.filter(function(d) { return d !== day; });
      } else {
        goal.checked.push(day);
      }
      renderGoals();
    }

    function renderGoals() {
      var container = document.getElementById('goals-container');
      container.innerHTML = '';

      if (goals.length === 0) {
        container.innerHTML = '<div style="color:#8E8E93; text-align:center; margin-top:40px;">No goals yet. Tap + to add one.</div>';
        return;
      }

      goals.forEach(function(g) {
        var totalDays = g.checkDays ? g.checkDays.length : 1;
        var checkedCount = g.checked ? g.checked.length : 0;
        var pct = Math.round((checkedCount / totalDays) * 100);

        var todayStr = localDateStr(new Date());

        // Show: up to 5 past days + today + tomorrow
        var nearbyDays = (g.checkDays || []).filter(function(d) {
          if (d === todayStr) return true;
          // Past: up to 5 days ago
          if (d < todayStr) {
            var diffMs = new Date(todayStr + 'T12:00:00') - new Date(d + 'T12:00:00');
            var diffDays = Math.round(diffMs / 86400000);
            return diffDays <= 5;
          }
          // Future: only tomorrow
          if (d > todayStr) {
            var diffMs = new Date(d + 'T12:00:00') - new Date(todayStr + 'T12:00:00');
            var diffDays = Math.round(diffMs / 86400000);
            return diffDays <= 1;
          }
          return false;
        });

        var checklistHTML = '';
        nearbyDays.forEach(function(day) {
          var isChecked = g.checked && g.checked.indexOf(day) !== -1;
          var label;
          if (day === todayStr) {
            label = 'Today';
          } else {
            var parts = day.split('-');
            var dateObj = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            label = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          }
          var isFuture = day > todayStr;
          checklistHTML +=
            '<div class="goal-check-row" style="' + (isFuture ? 'opacity:0.5' : '') + '">' +
              '<div class="goal-check ' + (isChecked ? 'checked' : '') + '" onclick="toggleGoalDay(' + g.id + ', \'' + day + '\')"></div>' +
              '<span class="goal-check-label ' + (isChecked ? 'checked' : '') + '">' + label + '</span>' +
            '</div>';
        });

        var div = document.createElement('div');
        div.className = 'goal-card';
        div.innerHTML =
          '<div class="goal-header">' +
            '<div>' +
              '<div class="goal-title">' + g.title + '</div>' +
              '<div class="goal-date">Target: ' + (g.date || 'No date') + '</div>' +
            '</div>' +
            '<div style="font-weight:700; color:var(--accent-color);">' + pct + '%</div>' +
          '</div>' +
          '<div class="progress-track">' +
            '<div class="progress-bar" style="width: ' + pct + '%"></div>' +
          '</div>' +
          '<div class="goal-checklist">' + checklistHTML + '</div>' +
          '<div style="text-align:center; margin-top:6px; font-size:12px; color:var(--text-secondary);">' +
            checkedCount + ' / ' + totalDays + ' days completed' +
          '</div>' +
          '<div class="goal-actions">' +
            '<button class="goal-action-btn" onclick="openGoalModal(' + g.id + ')">Edit</button>' +
            '<button class="goal-action-btn danger" onclick="confirmDeleteGoal(' + g.id + ')">Delete</button>' +
          '</div>';
        container.appendChild(div);
      });
    }

    function confirmDeleteGoal(id) {
      if (confirm("Delete this goal?")) {
        goals = goals.filter(function(g) { return g.id !== id; });
        renderGoals();
      }
    }

    // ===================== NAVIGATION =====================
    function switchView(viewName, el) {
      document.querySelectorAll('.view-section').forEach(function(v) { v.classList.remove('active'); });
      document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
      document.getElementById('view-' + viewName).classList.add('active');
      el.classList.add('active');
    }
  </script>
</body>
</html>
