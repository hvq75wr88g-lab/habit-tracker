<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Habits</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--bg:#000;--card:#1C1C1E;--txt:#FFF;--txt2:#8E8E93;--accent:#0A84FF;--ok:#30D158;--danger:#FF453A;--sep:#38383A;--font:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",sans-serif}
    body{background:var(--bg);color:var(--txt);font-family:var(--font);padding-bottom:90px;overflow-x:hidden}
    .view-section{display:none;padding-bottom:20px}.view-section.active{display:block;animation:fadeIn .2s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .top-bar{display:flex;justify-content:space-between;align-items:flex-end;padding:16px 20px 10px;position:sticky;top:0;background:rgba(0,0,0,.8);backdrop-filter:blur(20px);z-index:100}
    .app-title{font-size:34px;font-weight:700;letter-spacing:-.5px}
    .top-actions{display:flex;align-items:center;gap:16px}
    .date-sel-wrap{position:relative}
    .date-sel{color:var(--txt);font-size:17px;font-weight:600;display:flex;align-items:center;gap:6px;cursor:pointer;background:rgba(255,255,255,.1);padding:6px 14px;border-radius:20px}
    .date-dd{position:absolute;top:45px;right:0;background:#2C2C2E;border-radius:14px;width:220px;padding:8px;display:none;box-shadow:0 10px 40px rgba(0,0,0,.6);z-index:200;border:1px solid var(--sep)}
    .date-dd.active{display:block}
    .date-opt{padding:12px;border-radius:8px;cursor:pointer;font-size:16px}.date-opt:hover{background:#3A3A3C}.date-opt.selected{color:var(--accent);font-weight:600}
    .icon-btn{font-size:22px;color:var(--accent);cursor:pointer;padding:4px}
    .habit-list{padding:10px 16px;display:flex;flex-direction:column;gap:12px}
    .habit-card{background:var(--card);border-radius:14px;padding:16px;display:flex;align-items:center;justify-content:space-between}
    .habit-left{display:flex;align-items:center;gap:14px;flex:1;cursor:pointer}
    .habit-icon{font-size:24px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.05);border-radius:12px}
    .habit-details{display:flex;flex-direction:column;gap:4px}
    .habit-name{font-size:17px;font-weight:600}.habit-meta{font-size:13px;color:var(--txt2)}
    .chk{width:30px;height:30px;border-radius:50%;border:2px solid #48484A;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s cubic-bezier(.2,.8,.2,1);flex-shrink:0}
    .chk.done{background:var(--ok);border-color:var(--ok);box-shadow:0 0 15px rgba(48,209,88,.2)}.chk.done::after{content:'\2713';font-size:18px;color:#000;font-weight:800}
    .wk-badge{font-size:11px;color:var(--txt2);background:rgba(255,255,255,.06);padding:2px 8px;border-radius:10px;margin-left:8px;white-space:nowrap}.wk-badge.complete{color:var(--ok);background:rgba(48,209,88,.1)}
    .stats-container{padding:16px}
    .stats-card{background:var(--card);border-radius:18px;padding:24px 20px;margin-bottom:16px;text-align:center}
    .gauge-wrap{position:relative;width:180px;height:90px;margin:0 auto 10px;overflow:hidden}
    .gauge-bg{position:absolute;top:0;left:0;width:180px;height:180px;border-radius:50%;border:16px solid #2C2C2E;box-sizing:border-box}
    .gauge-fill{position:absolute;top:0;left:0;width:180px;height:180px;border-radius:50%;border:16px solid transparent;border-top-color:var(--accent);border-right-color:var(--accent);box-sizing:border-box;transform:rotate(-45deg);transition:transform .6s cubic-bezier(.2,.8,.2,1)}
    .gauge-main{font-size:42px;font-weight:800;color:#fff;margin-top:-10px}.gauge-sub{font-size:13px;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-top:4px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
    .stat-box{background:var(--card);border-radius:16px;padding:16px;display:flex;flex-direction:column;justify-content:space-between;height:110px}
    .stat-label{font-size:13px;color:var(--txt2);font-weight:500}.stat-val{font-size:28px;font-weight:700;color:var(--ok)}
    .hm-wrap{overflow-x:auto;padding-bottom:10px}
    .hm{display:grid;grid-template-rows:repeat(7,1fr);grid-auto-flow:column;gap:4px;height:140px}
    .hm-dot{width:14px;height:14px;background:#2C2C2E;border-radius:4px}.hm-dot.active{background:var(--accent)}
    .goal-card{background:var(--card);border-radius:16px;padding:20px;margin-bottom:12px}
    .goal-header{display:flex;justify-content:space-between;margin-bottom:12px;align-items:flex-start}
    .goal-title{font-size:18px;font-weight:600;margin-bottom:4px}.goal-date{font-size:13px;color:var(--txt2)}
    .prog-track{background:#2C2C2E;height:10px;border-radius:5px;overflow:hidden;margin-top:12px}
    .prog-bar{height:100%;background:var(--accent);border-radius:5px;transition:width .3s ease}
    .goal-cl{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .goal-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:.5px solid #2C2C2E;font-size:15px}.goal-row:last-child{border-bottom:none}
    .goal-chk{width:24px;height:24px;border-radius:50%;border:2px solid #48484A;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s ease;flex-shrink:0}
    .goal-chk.checked{background:var(--accent);border-color:var(--accent)}.goal-chk.checked::after{content:'\2713';font-size:14px;color:#fff;font-weight:800}
    .goal-lbl{color:var(--txt2);font-size:14px}.goal-lbl.checked{color:#fff;text-decoration:line-through;text-decoration-color:#48484A}
    .goal-acts{display:flex;gap:10px;margin-top:14px;justify-content:flex-end}
    .goal-btn{background:#3A3A3C;color:#fff;padding:8px 16px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:none}.goal-btn.danger{background:rgba(255,69,58,.15);color:var(--danger)}
    .bnav{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(28,28,30,.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:35px;padding:6px 8px;display:flex;gap:12px;box-shadow:0 10px 40px rgba(0,0,0,.6);z-index:1000;border:.5px solid rgba(255,255,255,.15)}
    .bnav-item{width:50px;height:50px;border-radius:25px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#8E8E93;cursor:pointer;transition:all .2s ease}.bnav-item.active{background:#3A3A3C;color:#fff}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:#000;z-index:2000;display:none;flex-direction:column;animation:slideUp .25s cubic-bezier(.16,1,.3,1)}.modal.active{display:flex}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .mhdr{padding:16px 20px;display:flex;justify-content:space-between;align-items:center;background:#1C1C1E;border-bottom:.5px solid #2C2C2E}
    .mcontent{padding:20px;flex:1;overflow-y:auto}
    .mact{color:var(--accent);font-size:17px;cursor:pointer}.mact.danger{color:var(--danger)}
    .fgroup{background:#2C2C2E;border-radius:12px;padding:0 16px;margin-bottom:24px}
    .frow{display:flex;align-items:center;padding:16px 0;border-bottom:.5px solid var(--sep)}.frow:last-child{border-bottom:none}
    .finput{background:transparent;border:none;color:#fff;font-size:17px;flex:1;margin-left:12px;outline:none}
    select:focus,input:focus{outline:none}
    .detail-view{position:fixed;top:0;left:0;right:0;bottom:0;background:#000;z-index:1500;display:none;flex-direction:column;animation:slideR .3s cubic-bezier(.16,1,.3,1)}.detail-view.active{display:flex}
    @keyframes slideR{from{transform:translateX(100%)}to{transform:translateX(0)}}
    #auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:40px 20px;text-align:center}
    #auth-screen h1{font-size:40px;font-weight:800;margin-bottom:8px}
    #auth-screen p{color:var(--txt2);font-size:16px;margin-bottom:40px}
    .auth-form{width:100%;max-width:360px}
    .auth-form input[type="email"]{width:100%;background:#2C2C2E;border:1px solid var(--sep);border-radius:12px;padding:16px;color:#fff;font-size:17px;margin-bottom:16px;outline:none}
    .auth-form input[type="email"]:focus{border-color:var(--accent)}
    .auth-form button{width:100%;background:var(--accent);color:#fff;border:none;border-radius:12px;padding:16px;font-size:17px;font-weight:600;cursor:pointer}
    .auth-form button:disabled{opacity:.5;cursor:not-allowed}
    .auth-msg{margin-top:20px;padding:16px;border-radius:12px;font-size:15px;display:none}
    .auth-msg.success{display:block;background:rgba(48,209,88,.1);color:var(--ok)}
    .auth-msg.error{display:block;background:rgba(255,69,58,.1);color:var(--danger)}
    .user-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 20px;font-size:13px;color:var(--txt2)}
    .user-bar a{color:var(--danger);cursor:pointer;text-decoration:none;font-weight:600}
    .loading-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;font-size:18px;color:var(--txt2)}
  </style>
</head>
<body>
  <div id="loading-screen" class="loading-screen">Loading...</div>
  <div id="auth-screen" style="display:none;">
    <h1>Habits</h1>
    <p>Sign in to sync your habits across devices</p>
    <div class="auth-form">
      <input type="email" id="auth-email" placeholder="Your email address" />
      <button id="auth-btn" onclick="sendMagicLink()">Send Magic Link</button>
      <div class="auth-msg" id="auth-msg"></div>
    </div>
  </div>
  <div id="app-container" style="display:none;">
    <div class="user-bar" id="user-bar"><span id="user-email"></span><a onclick="signOut()">Sign Out</a></div>
    <div id="view-habits" class="view-section active">
      <div class="top-bar">
        <div class="app-title">Habits</div>
        <div class="top-actions">
          <div class="date-sel-wrap">
            <div class="date-sel" onclick="toggleDateDropdown()"><span id="current-date-display">Today</span> <span style="font-size:12px;opacity:.7">‚ñº</span></div>
            <div class="date-dd" id="date-dropdown">
              <div class="date-opt" onclick="changeDate(-1)">Yesterday</div>
              <div class="date-opt selected" onclick="changeDate(0)">Today</div>
              <div class="date-opt" onclick="changeDate(1)">Tomorrow</div>
            </div>
          </div>
          <div class="icon-btn" onclick="openAddModal()">+</div>
        </div>
      </div>
      <div class="habit-list" id="habits-container"></div>
    </div>
    <div id="view-stats" class="view-section stats-container">
      <div class="app-title" style="margin-bottom:20px">Statistics</div>
      <div class="stats-card">
        <div class="gauge-wrap"><div class="gauge-bg"></div><div class="gauge-fill" id="gauge-fill"></div></div>
        <div class="gauge-main" id="stats-percentage">0%</div>
        <div class="gauge-sub">Weekly Completion</div>
      </div>
      <div class="grid-2">
        <div class="stat-box"><div class="stat-label">Habit Accuracy</div><div class="stat-val" id="stats-accuracy">0%</div></div>
        <div class="stat-box"><div class="stat-label">Consistency</div><div class="stat-val" style="color:var(--accent)" id="stats-consistency">0%</div></div>
      </div>
      <div class="stats-card" style="text-align:left">
        <div style="display:flex;justify-content:space-between;margin-bottom:12px"><span style="font-weight:600">Activity Log</span><span style="color:var(--txt2);font-size:13px">Last 10 Weeks</span></div>
        <div class="hm-wrap"><div class="hm" id="heat-map"></div></div>
      </div>
    </div>
    <div id="view-goals" class="view-section" style="padding:20px">
      <div class="top-bar" style="padding:0 0 20px 0"><div class="app-title">Goals</div><div class="icon-btn" onclick="openGoalModal()">+</div></div>
      <div id="goals-container"></div>
    </div>
    <div class="bnav">
      <div class="bnav-item active" onclick="switchView('habits',this)">üìÖ</div>
      <div class="bnav-item" onclick="switchView('stats',this)">üìä</div>
      <div class="bnav-item" onclick="switchView('goals',this)">üéØ</div>
    </div>
  </div>

  <div id="modal-habit" class="modal">
    <div class="mhdr">
      <div class="mact" onclick="closeModal('habit')">Cancel</div>
      <div id="habit-modal-title">New Habit</div>
      <div class="mact" style="font-weight:600" onclick="saveHabit()">Save</div>
    </div>
    <div class="mcontent">
      <div class="fgroup">
        <div class="frow"><span>‚úèÔ∏è</span><input type="text" id="habit-name" class="finput" placeholder="Name" /></div>
        <div class="frow"><span>üìÑ</span><input type="text" id="habit-desc" class="finput" placeholder="Description (e.g. 5 pages)" /></div>
      </div>
      <div class="fgroup">
        <div class="frow" style="justify-content:space-between"><span>Icon</span><input type="text" id="habit-icon" class="finput" value="üìö" style="text-align:right;width:50px" /></div>
        <div class="frow" style="justify-content:space-between"><span>Color</span>
          <select id="habit-color" style="background:none;border:none;color:#fff;text-align:right;font-size:16px">
            <option value="#0A84FF">Blue</option><option value="#FF453A">Red</option><option value="#30D158">Green</option>
            <option value="#FF9F0A">Orange</option><option value="#BF5AF2">Purple</option><option value="#FFD60A">Yellow</option>
          </select></div>
        <div class="frow" style="justify-content:space-between"><span>Frequency</span>
          <select id="habit-frequency" style="background:none;border:none;color:#fff;text-align:right;font-size:16px">
            <option value="7">Every day (7/week)</option><option value="6">6 times / week</option><option value="5">5 times / week</option>
            <option value="4">4 times / week</option><option value="3">3 times / week</option><option value="2">2 times / week</option><option value="1">1 time / week</option>
          </select></div>
      </div>
      <div class="fgroup" id="delete-section" style="display:none;margin-top:30px;background:rgba(255,69,58,.1)">
        <div class="frow" style="justify-content:center;border:none"><span class="mact danger" onclick="deleteHabit()" style="width:100%;text-align:center;padding:4px">Delete Habit</span></div>
      </div>
    </div>
  </div>

  <div id="modal-goal" class="modal">
    <div class="mhdr">
      <div class="mact" onclick="closeModal('goal')">Cancel</div>
      <div id="goal-modal-title">New Goal</div>
      <div class="mact" style="font-weight:600" onclick="saveGoal()">Save</div>
    </div>
    <div class="mcontent">
      <div class="fgroup">
        <div class="frow"><span>üéØ</span><input type="text" id="goal-title" class="finput" placeholder="Goal Title" /></div>
        <div class="frow"><span>üìÖ</span><input type="date" id="goal-date" class="finput" style="color-scheme:dark" /></div>
      </div>
      <div class="fgroup" id="goal-delete-section" style="display:none;margin-top:30px;background:rgba(255,69,58,.1)">
        <div class="frow" style="justify-content:center;border:none"><span class="mact danger" onclick="deleteGoal()" style="width:100%;text-align:center;padding:4px">Delete Goal</span></div>
      </div>
    </div>
  </div>

  <div id="view-habit-detail" class="detail-view">
    <div class="mhdr">
      <div class="mact" onclick="closeHabitDetail()">‚Üê Back</div>
      <div id="detail-title">Habit Details</div>
      <div class="mact" onclick="editCurrentHabit()">Edit</div>
    </div>
    <div class="mcontent">
      <div class="stats-card" style="padding:30px">
        <div style="font-size:50px;margin-bottom:16px" id="detail-icon">üìö</div>
        <div style="font-size:28px;font-weight:700" id="detail-name">Reading</div>
        <div style="color:var(--txt2);margin-top:6px;font-size:16px" id="detail-desc">5 pages</div>
        <div style="color:var(--txt2);margin-top:8px;font-size:14px" id="detail-freq"></div>
      </div>
      <div class="grid-2">
        <div class="stat-box"><div class="stat-label">Current Streak</div><div class="stat-val" id="detail-streak">0</div></div>
        <div class="stat-box"><div class="stat-label">Total Completions</div><div class="stat-val" style="color:var(--accent)" id="detail-total">0</div></div>
      </div>
      <div class="stats-card" style="text-align:left"><div style="font-weight:600;margin-bottom:12px">History</div><div class="hm-wrap"><div class="hm" id="detail-heatmap"></div></div></div>
    </div>
  </div>

  <script>
    var sb=supabase.createClient('https://dssywydywiqukaagisce.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzc3l3eWR5d2lxdWthYWdpc2NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3ODQzMjksImV4cCI6MjA4NjM2MDMyOX0.nGzvYHRWGKWPWc8wsjt19Xfx9btCZkyrz-YueksnLkI');
    var currentUser=null,habits=[],completions=[],goals=[],goalDays=[];
    var selectedDate=new Date(),currentHabitId=null,currentGoalId=null;

    function ld(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
    function getMon(d){var dt=new Date(d.getFullYear(),d.getMonth(),d.getDate());var day=dt.getDay();dt.setDate(dt.getDate()+(day===0?-6:1-day));return dt}
    function elapsed(d){var m=getMon(d),t=new Date(),td=new Date(t.getFullYear(),t.getMonth(),t.getDate()),e=new Date(m);e.setDate(e.getDate()+6);var end=td<e?td:e;return Math.max(1,Math.min(7,Math.round((end-m)/864e5)+1))}
    function wkCount(hid,d){var m=getMon(d),s=new Date(m);s.setDate(s.getDate()+6);var ms=ld(m),ss=ld(s);return completions.filter(function(c){return c.habit_id===hid&&c.day>=ms&&c.day<=ss}).length}
    function isDone(hid,ds){return completions.some(function(c){return c.habit_id===hid&&c.day===ds})}

    async function checkAuth(){var{data:{session}}=await sb.auth.getSession();if(session){currentUser=session.user;showApp()}else{document.getElementById('loading-screen').style.display='none';document.getElementById('auth-screen').style.display='flex'}}
    sb.auth.onAuthStateChange(function(ev,session){if(ev==='SIGNED_IN'&&session){currentUser=session.user;showApp()}});

    async function sendMagicLink(){
      var email=document.getElementById('auth-email').value.trim();if(!email)return;
      var btn=document.getElementById('auth-btn'),msg=document.getElementById('auth-msg');
      btn.disabled=true;btn.textContent='Sending...';msg.className='auth-msg';msg.style.display='none';
      var{error}=await sb.auth.signInWithOtp({email:email,options:{emailRedirectTo:'https://hvq75wr88g-lab.github.io/habit-tracker/'}});
      if(error){msg.className='auth-msg error';msg.textContent=error.message;msg.style.display='block'}
      else{msg.className='auth-msg success';msg.textContent='Check your email! Click the link to sign in.';msg.style.display='block'}
      btn.disabled=false;btn.textContent='Send Magic Link';
    }

    async function signOut(){await sb.auth.signOut();currentUser=null;habits=[];completions=[];goals=[];goalDays=[];document.getElementById('app-container').style.display='none';document.getElementById('auth-screen').style.display='flex'}

    async function showApp(){
      document.getElementById('loading-screen').style.display='none';document.getElementById('auth-screen').style.display='none';
      document.getElementById('app-container').style.display='block';document.getElementById('user-email').textContent=currentUser.email;
      await loadAll();renderHabits();renderStats();renderGoals();updateDateDisplay();
    }

    async function loadAll(){
      var uid=currentUser.id;
      var[hR,cR,gR,gdR]=await Promise.all([
        sb.from('habits').select('*').eq('user_id',uid).order('created_at'),
        sb.from('completions').select('habit_id,day').eq('user_id',uid),
        sb.from('goals').select('*').eq('user_id',uid).order('created_at'),
        sb.from('goal_days').select('goal_id,day').eq('user_id',uid)
      ]);
      habits=(hR.data||[]).map(function(h){return{id:h.id,name:h.name,desc:h.description||'',icon:h.icon||'üìö',color:h.color||'#0A84FF',frequency:h.frequency||7}});
      completions=(cR.data||[]).map(function(c){return{habit_id:c.habit_id,day:c.day}});
      goals=(gR.data||[]).map(function(g){return{id:g.id,title:g.title,date:g.target_date,startDate:g.start_date}});
      goalDays=(gdR.data||[]).map(function(d){return{goal_id:d.goal_id,day:d.day}});
    }

    function renderHabits(){
      var c=document.getElementById('habits-container');c.innerHTML='';var ds=ld(selectedDate);
      habits.forEach(function(h){
        var done=isDone(h.id,ds),wc=wkCount(h.id,selectedDate),wt=h.frequency||7,wm=wc>=wt;
        var d=document.createElement('div');d.className='habit-card';
        d.innerHTML='<div class="habit-left" onclick="openHabitDetail('+h.id+')"><div class="habit-icon">'+h.icon+'</div><div class="habit-details"><div class="habit-name">'+h.name+'</div><div class="habit-meta">'+h.desc+(wt<7?' <span class="wk-badge '+(wm?'complete':'')+'">'+wc+'/'+wt+' this week</span>':'')+'</div></div></div><div class="chk '+(done?'done':'')+'" onclick="toggleHabit('+h.id+')" style="'+(done?'background-color:'+h.color+';border-color:'+h.color:'')+'"></div>';
        c.appendChild(d);
      });
    }

    async function toggleHabit(id){
      var ds=ld(selectedDate),ex=completions.find(function(c){return c.habit_id===id&&c.day===ds});
      if(ex){await sb.from('completions').delete().eq('user_id',currentUser.id).eq('habit_id',id).eq('day',ds);completions=completions.filter(function(c){return!(c.habit_id===id&&c.day===ds)})}
      else{await sb.from('completions').insert({user_id:currentUser.id,habit_id:id,day:ds});completions.push({habit_id:id,day:ds});if(navigator.vibrate)navigator.vibrate(10)}
      renderHabits();renderStats();
    }

    function toggleDateDropdown(){document.getElementById('date-dropdown').classList.toggle('active')}
    function changeDate(o){selectedDate.setDate(selectedDate.getDate()+o);updateDateDisplay();document.getElementById('date-dropdown').classList.remove('active');renderHabits()}
    function updateDateDisplay(){var t=new Date(),l=selectedDate.toLocaleDateString();if(selectedDate.toDateString()===t.toDateString())l="Today";else if(selectedDate.getDate()===t.getDate()-1&&selectedDate.getMonth()===t.getMonth())l="Yesterday";else if(selectedDate.getDate()===t.getDate()+1&&selectedDate.getMonth()===t.getMonth())l="Tomorrow";document.getElementById('current-date-display').textContent=l}

    function openAddModal(){currentHabitId=null;document.getElementById('habit-modal-title').textContent="New Habit";document.getElementById('habit-name').value="";document.getElementById('habit-desc').value="";document.getElementById('habit-icon').value="üìö";document.getElementById('habit-color').value="#0A84FF";document.getElementById('habit-frequency').value="7";document.getElementById('delete-section').style.display='none';document.getElementById('modal-habit').classList.add('active')}

    function editCurrentHabit(){var h=habits.find(function(h){return h.id===currentHabitId});document.getElementById('habit-modal-title').textContent="Edit Habit";document.getElementById('habit-name').value=h.name;document.getElementById('habit-desc').value=h.desc;document.getElementById('habit-icon').value=h.icon;document.getElementById('habit-color').value=h.color;document.getElementById('habit-frequency').value=String(h.frequency||7);document.getElementById('delete-section').style.display='block';closeHabitDetail();document.getElementById('modal-habit').classList.add('active')}

    async function saveHabit(){
      var nm=document.getElementById('habit-name').value,ds=document.getElementById('habit-desc').value,ic=document.getElementById('habit-icon').value,cl=document.getElementById('habit-color').value,fr=parseInt(document.getElementById('habit-frequency').value);
      if(!nm)return;
      if(currentHabitId){await sb.from('habits').update({name:nm,description:ds,icon:ic,color:cl,frequency:fr}).eq('id',currentHabitId).eq('user_id',currentUser.id);var h=habits.find(function(h){return h.id===currentHabitId});h.name=nm;h.desc=ds;h.icon=ic;h.color=cl;h.frequency=fr}
      else{var{data}=await sb.from('habits').insert({user_id:currentUser.id,name:nm,description:ds,icon:ic,color:cl,frequency:fr}).select();if(data&&data[0])habits.push({id:data[0].id,name:nm,desc:ds,icon:ic,color:cl,frequency:fr})}
      closeModal('habit');renderHabits();renderStats();
    }

    async function deleteHabit(){if(!confirm("Delete this habit?"))return;await sb.from('habits').delete().eq('id',currentHabitId).eq('user_id',currentUser.id);completions=completions.filter(function(c){return c.habit_id!==currentHabitId});habits=habits.filter(function(h){return h.id!==currentHabitId});closeModal('habit');renderHabits();renderStats()}
    function closeModal(t){document.getElementById('modal-'+t).classList.remove('active')}

    function openHabitDetail(id){
      currentHabitId=id;var h=habits.find(function(h){return h.id===id});
      document.getElementById('detail-name').textContent=h.name;document.getElementById('detail-desc').textContent=h.desc;document.getElementById('detail-icon').textContent=h.icon;
      document.getElementById('detail-total').textContent=completions.filter(function(c){return c.habit_id===id}).length;
      document.getElementById('detail-streak').textContent=calcStreak(h);
      document.getElementById('detail-freq').textContent=(h.frequency||7)===7?"Every day":(h.frequency||7)+" times per week";
      renderDetailHM(h);document.getElementById('view-habit-detail').classList.add('active');
    }
    function closeHabitDetail(){document.getElementById('view-habit-detail').classList.remove('active')}

    function calcStreak(h){
      var hc=completions.filter(function(c){return c.habit_id===h.id}).map(function(c){return c.day});
      if(hc.length===0)return"0";var fr=h.frequency||7;
      if(fr===7){var s=0,d=new Date();d.setHours(0,0,0,0);while(hc.indexOf(ld(d))!==-1){s++;d.setDate(d.getDate()-1)}return"üî• "+s}
      else{var s=0,cd=new Date();while(true){if(wkCount(h.id,cd)>=fr){s++;cd.setDate(cd.getDate()-7)}else break}return"üî• "+s+(s===1?" week":" weeks")}
    }

    function renderStats(){
      var t=new Date(),tt=0,td=0;
      habits.forEach(function(h){var fr=h.frequency||7,wc=wkCount(h.id,t);tt+=fr;td+=Math.min(wc,fr)});
      var pct=tt===0?0:Math.round(td/tt*100);
      document.getElementById('stats-percentage').textContent=pct+'%';
      document.getElementById('gauge-fill').style.transform='rotate('+(-225+pct/100*180)+'deg)';
      var hot=0,ts=ld(t);
      habits.forEach(function(h){var fr=h.frequency||7;if(fr===7){if(isDone(h.id,ts))hot++}else{if(wkCount(h.id,t)>=fr)hot++}});
      document.getElementById('stats-accuracy').textContent=(habits.length===0?0:Math.round(hot/habits.length*100))+'%';
      var el=elapsed(t),mon=getMon(t),pd=0;
      for(var d=0;d<el;d++){var cd=new Date(mon);cd.setDate(cd.getDate()+d);var ds=ld(cd),ok=true;for(var i=0;i<habits.length;i++){if((habits[i].frequency||7)===7&&!isDone(habits[i].id,ds)){ok=false;break}}if(ok)pd++}
      document.getElementById('stats-consistency').textContent=(habits.length===0?0:Math.round(pd/el*100))+'%';
      renderHM();
    }

    function renderHM(){var c=document.getElementById('heat-map');c.innerHTML='';for(var i=0;i<70;i++){var d=new Date();d.setDate(d.getDate()-(69-i));var ds=ld(d),dn=habits.filter(function(h){return isDone(h.id,ds)}).length;var dot=document.createElement('div');dot.className='hm-dot';if(dn>0&&dn>=habits.length/2)dot.classList.add('active');c.appendChild(dot)}}
    function renderDetailHM(h){var c=document.getElementById('detail-heatmap');c.innerHTML='';for(var i=0;i<60;i++){var d=new Date();d.setDate(d.getDate()-(59-i));var dot=document.createElement('div');dot.className='hm-dot';if(isDone(h.id,ld(d)))dot.classList.add('active');c.appendChild(dot)}}

    function openGoalModal(eid){
      currentGoalId=eid||null;
      if(currentGoalId){var g=goals.find(function(g){return g.id===currentGoalId});document.getElementById('goal-modal-title').textContent="Edit Goal";document.getElementById('goal-title').value=g.title;document.getElementById('goal-date').value=g.date;document.getElementById('goal-delete-section').style.display='block'}
      else{document.getElementById('goal-modal-title').textContent="New Goal";document.getElementById('goal-title').value='';document.getElementById('goal-date').value='';document.getElementById('goal-delete-section').style.display='none'}
      document.getElementById('modal-goal').classList.add('active');
    }

    async function saveGoal(){
      var ti=document.getElementById('goal-title').value,dt=document.getElementById('goal-date').value;if(!ti||!dt)return;
      if(currentGoalId){await sb.from('goals').update({title:ti,target_date:dt}).eq('id',currentGoalId).eq('user_id',currentUser.id);var g=goals.find(function(g){return g.id===currentGoalId});g.title=ti;g.date=dt}
      else{var sd=ld(new Date());var{data}=await sb.from('goals').insert({user_id:currentUser.id,title:ti,target_date:dt,start_date:sd}).select();if(data&&data[0])goals.push({id:data[0].id,title:ti,date:dt,startDate:sd})}
      renderGoals();closeModal('goal');
    }

    async function deleteGoal(){if(!confirm("Delete this goal?"))return;await sb.from('goals').delete().eq('id',currentGoalId).eq('user_id',currentUser.id);goalDays=goalDays.filter(function(d){return d.goal_id!==currentGoalId});goals=goals.filter(function(g){return g.id!==currentGoalId});closeModal('goal');renderGoals()}

    function buildDays(s,e){var days=[],d=new Date(s+'T12:00:00'),end=new Date(e+'T12:00:00');while(d<=end){days.push(ld(d));d.setDate(d.getDate()+1)}return days}

    async function toggleGoalDay(gid,day){
      var ex=goalDays.find(function(d){return d.goal_id===gid&&d.day===day});
      if(ex){await sb.from('goal_days').delete().eq('user_id',currentUser.id).eq('goal_id',gid).eq('day',day);goalDays=goalDays.filter(function(d){return!(d.goal_id===gid&&d.day===day)})}
      else{await sb.from('goal_days').insert({user_id:currentUser.id,goal_id:gid,day:day});goalDays.push({goal_id:gid,day:day})}
      renderGoals();
    }

    function renderGoals(){
      var c=document.getElementById('goals-container');c.innerHTML='';
      if(goals.length===0){c.innerHTML='<div style="color:var(--txt2);text-align:center;margin-top:40px">No goals yet. Tap + to add one.</div>';return}
      goals.forEach(function(g){
        var ad=buildDays(g.startDate,g.date),cc=goalDays.filter(function(d){return d.goal_id===g.id}).length;
        var pct=ad.length===0?0:Math.round(cc/ad.length*100),ts=ld(new Date());
        var nd=ad.filter(function(d){if(d>ts)return false;if(d===ts)return true;var df=Math.round((new Date(ts+'T12:00:00')-new Date(d+'T12:00:00'))/864e5);return df<=7});
        var clHTML='';
        nd.forEach(function(day){
          var ck=goalDays.some(function(d){return d.goal_id===g.id&&d.day===day});
          var lbl=day===ts?'Today':new Date(day.split('-')[0],day.split('-')[1]-1,day.split('-')[2]).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
          clHTML+='<div class="goal-row"><div class="goal-chk '+(ck?'checked':'')+'" onclick="toggleGoalDay('+g.id+',\''+day+'\')"></div><span class="goal-lbl '+(ck?'checked':'')+'">'+lbl+'</span></div>';
        });
        var div=document.createElement('div');div.className='goal-card';
        div.innerHTML='<div class="goal-header"><div><div class="goal-title">'+g.title+'</div><div class="goal-date">Target: '+g.date+'</div></div><div style="font-weight:700;color:var(--accent)">'+pct+'%</div></div><div class="prog-track"><div class="prog-bar" style="width:'+pct+'%"></div></div><div class="goal-cl">'+clHTML+'</div><div style="text-align:center;margin-top:6px;font-size:12px;color:var(--txt2)">'+cc+' / '+ad.length+' days completed</div><div class="goal-acts"><button class="goal-btn" onclick="openGoalModal('+g.id+')">Edit</button><button class="goal-btn danger" onclick="confirmDeleteGoal('+g.id+')">Delete</button></div>';
        c.appendChild(div);
      });
    }

    async function confirmDeleteGoal(id){if(!confirm("Delete this goal?"))return;await sb.from('goals').delete().eq('id',id).eq('user_id',currentUser.id);goalDays=goalDays.filter(function(d){return d.goal_id!==id});goals=goals.filter(function(g){return g.id!==id});renderGoals()}

    function switchView(v,el){document.querySelectorAll('.view-section').forEach(function(s){s.classList.remove('active')});document.querySelectorAll('.bnav-item').forEach(function(n){n.classList.remove('active')});document.getElementById('view-'+v).classList.add('active');el.classList.add('active')}

    checkAuth();
  </script>
</body>
</html>
